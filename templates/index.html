{% extends "base.html" %}
{% block title %}IndFlow — Dashboard{% endblock %}

{% block content %}

<div class="dashboard-wrapper">

  <style>
    .dashboard-wrapper{
      width:100%;
      display:flex;
      justify-content:center;
      padding:32px 0;
    }

    .machine-card{
      background:#ffffff;
      width:420px;
      border-radius:20px;
      padding:28px;
      box-shadow:0 4px 14px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
      gap:18px;
      border:1px solid #e5e7eb;
      cursor:pointer;
      transition:0.15s;
    }

    .machine-card:hover{
      box-shadow:0 6px 18px rgba(0,0,0,0.2);
      transform:translateY(-2px);
    }

    .machine-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .machine-name{
      font-size:24px;
      font-weight:700;
      color:#0f172a;
    }

    .machine-status{
      font-size:14px;
      font-weight:600;
      padding:8px 14px;
      border-radius:6px;
      color:white;
      text-transform:uppercase;
    }

    .status-auto{ background:#16a34a; }
    .status-manual{ background:#dc2626; }

    .percent-container{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-top:10px;
    }

    .percent-block{
      width:45%;
      text-align:center;
    }

    .percent-value{
      font-size:62px;
      font-weight:700;
      color:#0f172a;
      line-height:1;
    }

    .percent-label{
      margin-top:6px;
      font-size:18px;
      font-weight:600;
      color:#475569;
    }

    .divider{
      width:2px;
      height:140px;
      background:#cbd5e1;
      border-radius:2px;
    }

    .stats-sub{
      margin-top:14px;
      font-size:18px;
      font-weight:600;
      color:#334155;
      display:flex;
      justify-content:space-between;
    }

    .stats-sub b{
      font-weight:700;
      color:#0f172a;
    }

    /* NOVO */
    .ritmo-medio{
      margin-top:10px;
      text-align:right;
      font-size:15px;
      font-weight:600;
      color:#334155;
    }
  </style>

  <div class="machine-card" onclick="window.location.href='/producao/config/maquina01'">

    <div class="machine-header">
      <div class="machine-name">MAQUINA 01</div>
      <div id="status-badge" class="machine-status status-auto">AUTO</div>
    </div>

    <div class="percent-container">

      <div class="percent-block">
        <div class="percent-value" id="percent-turno">0%</div>
        <div class="percent-label">Meta do Turno</div>

        <div class="stats-sub">
          <span>Meta</span>
          <b id="meta-turno">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido</span>
          <b id="prod-turno">0</b>
        </div>
      </div>

      <div class="divider"></div>

      <div class="percent-block">
        <div class="percent-value" id="percent-hora">0%</div>
        <div class="percent-label">Meta da Hora</div>

        <div class="stats-sub">
          <span>Meta</span>
          <b id="meta-hora">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido</span>
          <b id="prod-hora">0</b>
        </div>
      </div>

    </div>

    <!-- NOVA LINHA -->
    <div class="ritmo-medio" id="ritmo-medio">
      Ritmo médio: —
    </div>

  </div>

</div>

<script>
function formatTempoMedio(v){
  const n = Number(v);
  if(!Number.isFinite(n) || n <= 0) return "—";
  return n.toFixed(2).replace(".", ",");
}

function atualizarDashboard(){

  fetch("/machine/status")
    .then(r => r.json())
    .then(data => {

      let statusBadge = document.getElementById("status-badge");
      statusBadge.textContent = data.status;
      statusBadge.className =
        "machine-status " + (data.status === "AUTO" ? "status-auto" : "status-manual");

      document.getElementById("percent-turno").textContent = data.percentual_turno + "%";
      document.getElementById("meta-turno").textContent = data.meta_turno;
      document.getElementById("prod-turno").textContent = data.producao_turno;

      document.getElementById("percent-hora").textContent = data.percentual_hora + "%";
      document.getElementById("meta-hora").textContent =
        data.meta_por_hora?.[data.ultima_hora] ?? 0;
      document.getElementById("prod-hora").textContent = data.producao_hora;

      document.getElementById("ritmo-medio").textContent =
        "Ritmo médio: " + formatTempoMedio(data.tempo_medio_min_por_peca) + " min/peça";
    });
}

setInterval(atualizarDashboard, 1000);
atualizarDashboard();
</script>

{% endblock %}
