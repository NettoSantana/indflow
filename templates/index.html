{% extends "base.html" %}
{% block title %}IndFlow — Dashboard{% endblock %}

{% block content %}

<div class="dashboard-wrapper">

  <style>
    .dashboard-wrapper{
      width:100%;
      display:flex;
      justify-content:center;
      padding:32px 0;
    }

    .machine-card{
      background:#ffffff;
      width:460px;
      border-radius:20px;
      padding:28px;
      box-shadow:0 4px 14px rgba(0,0,0,0.12);
      display:flex;
      flex-direction:column;
      gap:18px;
      border:1px solid #e5e7eb;
      cursor:pointer;
      transition:0.15s;
    }

    .machine-card:hover{
      box-shadow:0 6px 18px rgba(0,0,0,0.2);
      transform:translateY(-2px);
    }

    .machine-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .machine-name{
      font-size:24px;
      font-weight:700;
      color:#0f172a;
    }

    .machine-status{
      font-size:14px;
      font-weight:600;
      padding:8px 14px;
      border-radius:6px;
      color:white;
      text-transform:uppercase;
    }

    .status-auto{ background:#16a34a; }
    .status-manual{ background:#dc2626; }

    .percent-container{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-top:10px;
    }

    .percent-block{
      width:45%;
      text-align:center;
    }

    .percent-value{
      font-size:62px;
      font-weight:700;
      color:#0f172a;
      line-height:1;
    }

    .percent-label{
      margin-top:6px;
      font-size:18px;
      font-weight:600;
      color:#475569;
    }

    .divider{
      width:2px;
      height:200px;
      background:#cbd5e1;
      border-radius:2px;
    }

    .stats-sub{
      margin-top:10px;
      font-size:15px;
      font-weight:600;
      color:#334155;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .stats-sub b{
      font-weight:700;
      color:#0f172a;
    }

    .ritmo-medio{
      margin-top:12px;
      text-align:right;
      font-size:15px;
      font-weight:600;
      color:#334155;
    }
  </style>

  <div class="machine-card" onclick="window.location.href='/producao/config/maquina01'">

    <div class="machine-header">
      <div class="machine-name">MAQUINA 01</div>
      <div id="status-badge" class="machine-status status-auto">AUTO</div>
    </div>

    <div class="percent-container">

      <!-- TURNO -->
      <div class="percent-block">
        <div class="percent-value" id="percent-turno">0%</div>
        <div class="percent-label">Meta do Turno</div>

        <div class="stats-sub">
          <span>Meta (UNI)</span>
          <b id="meta-turno-uni">0</b>
        </div>

        <div class="stats-sub">
          <span>Meta (ML)</span>
          <b id="meta-turno-ml">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido (UNI)</span>
          <b id="prod-turno-uni">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido (ML)</span>
          <b id="prod-turno-ml">0</b>
        </div>
      </div>

      <div class="divider"></div>

      <!-- HORA -->
      <div class="percent-block">
        <div class="percent-value" id="percent-hora">0%</div>
        <div class="percent-label">Meta da Hora</div>

        <div class="stats-sub">
          <span>Meta (UNI)</span>
          <b id="meta-hora-uni">0</b>
        </div>

        <div class="stats-sub">
          <span>Meta (ML)</span>
          <b id="meta-hora-ml">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido (UNI)</span>
          <b id="prod-hora-uni">0</b>
        </div>

        <div class="stats-sub">
          <span>Produzido (ML)</span>
          <b id="prod-hora-ml">0</b>
        </div>
      </div>

    </div>

    <div class="ritmo-medio" id="ritmo-medio">
      Ritmo médio: —
    </div>

  </div>

</div>

<script>
function fmt(n){
  const x = Number(n);
  if(!Number.isFinite(x)) return "0";
  return x.toLocaleString("pt-BR", { maximumFractionDigits: 2 });
}

function atualizarDashboard(){
  fetch("/machine/status")
    .then(r => r.json())
    .then(data => {

      // STATUS
      const statusBadge = document.getElementById("status-badge");
      statusBadge.textContent = data.status;
      statusBadge.className =
        "machine-status " + (data.status === "AUTO" ? "status-auto" : "status-manual");

      // TURN0
      document.getElementById("percent-turno").textContent = data.percentual_turno + "%";
      document.getElementById("meta-turno-uni").textContent = fmt(data.meta_turno);
      document.getElementById("meta-turno-ml").textContent = fmt(data.meta_turno_ml);
      document.getElementById("prod-turno-uni").textContent = fmt(data.producao_turno);
      document.getElementById("prod-turno-ml").textContent = fmt(data.producao_turno_ml);

      // HORA
      document.getElementById("percent-hora").textContent = data.percentual_hora + "%";
      document.getElementById("meta-hora-uni").textContent = fmt(data.meta_hora_pcs);
      document.getElementById("meta-hora-ml").textContent = fmt(data.meta_hora_ml);
      document.getElementById("prod-hora-uni").textContent = fmt(data.producao_hora);
      document.getElementById("prod-hora-ml").textContent = fmt(data.producao_hora_ml);

      // RITMO
      const tm = Number(data.tempo_medio_min_por_peca);
      document.getElementById("ritmo-medio").textContent =
        Number.isFinite(tm) && tm > 0
          ? "Ritmo médio: " + tm.toFixed(2).replace(".", ",") + " min/peça"
          : "Ritmo médio: —";
    });
}

setInterval(atualizarDashboard, 1000);
atualizarDashboard();
</script>

{% endblock %}
