{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}

{% block content %}

<div class="container">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

    <div style="display:flex; gap:10px;">
      <!-- BOTÃO HISTÓRICO -->
      <a id="btn-historico"
         href="#"
         class="btn btn-secondary">
         Histórico
      </a>

      <!-- BOTÃO RESET -->
      <button id="btn-reset"
              class="btn"
              style="background:#dc2626;color:#fff;">
        Zerar Produção
      </button>
    </div>
  </div>

  <div class="card">

    <form id="config-form">

      <!-- META DO TURNO -->
      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <!-- NOVO: UNIDADE DE PRODUÇÃO (ATÉ 2) -->
      <label class="mt-20">Unidade de Produção (até 2):</label>

      <div class="row">
        <div class="col">
          <select id="unidade_1" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>

        <div class="col">
          <select id="unidade_2" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
      </div>

      <!-- NOVO: CONVERSOR (1 pcs = X m) -->
      <label class="mt-20">Conversão (1 pcs = X metros):</label>
      <input
        type="number"
        id="conv_m_por_pcs"
        class="input"
        step="0.001"
        min="0.001"
        placeholder="Ex: 0.85"
        required
      >

      <!-- HORÁRIOS -->
      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>

        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <!-- RAMPA -->
      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">
        Salvar Configuração
      </button>
    </form>

  </div>

  <!-- TABELA GERADA AUTOMATICAMENTE -->
  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>

          <!-- NOVO -->
          <th>Produzido Hora</th>
          <th>Refugo Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const machine_id = window.location.pathname.split("/").pop();

document.getElementById("titulo-maquina").textContent =
  "Configuração da Máquina — " + machine_id.toUpperCase();

document.getElementById("btn-historico").href =
  `/producao/historico?machine_id=${machine_id}`;

// ===========================================
// RESET MANUAL
// ===========================================
document.getElementById("btn-reset").addEventListener("click", function(){
  if(!confirm("CONFIRMAR RESET DA PRODUÇÃO?\nEssa ação grava histórico e zera os contadores.")){
    return;
  }

  fetch("/admin/reset-manual", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ machine_id })
  })
  .then(r => r.json())
  .then(() => {
    alert("Produção zerada com sucesso.");
    carregarTabela();
  });
});

// ===========================================
// UNIDADES: não permitir duplicado
// ===========================================
function garantirSemDuplicar(){
  const u1 = document.getElementById("unidade_1");
  const u2 = document.getElementById("unidade_2");
  if(u1.value && u2.value && u1.value === u2.value){
    u2.value = "";
  }
}
document.getElementById("unidade_1").addEventListener("change", garantirSemDuplicar);
document.getElementById("unidade_2").addEventListener("change", garantirSemDuplicar);

// ===========================================
// SUBMIT DO FORMULÁRIO
// ===========================================
document.getElementById("config-form").addEventListener("submit", function(e){
  e.preventDefault();

  garantirSemDuplicar();

  // valida conversão > 0
  const conv = Number(document.getElementById("conv_m_por_pcs").value);
  if(!Number.isFinite(conv) || conv <= 0){
    alert("Conversão inválida. Use um número maior que zero. Ex: 0.85");
    return;
  }

  fetch("/machine/config", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id: machine_id,
      meta_turno: document.getElementById("meta").value,
      inicio: document.getElementById("inicio").value,
      fim: document.getElementById("fim").value,
      rampa: document.getElementById("rampa").value,

      unidade_1: document.getElementById("unidade_1").value,
      unidade_2: document.getElementById("unidade_2").value,

      conv_m_por_pcs: document.getElementById("conv_m_por_pcs").value
    })
  })
  .then(r => r.json())
  .then(() => {
    alert("Configuração salva com sucesso!");
    carregarTabela();
  });
});

// ===========================================
// BUSCAR STATUS + TABELA
// ===========================================
function carregarTabela(){
  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {

      // carrega unidades salvas
      document.getElementById("unidade_1").value = data.unidade_1 ?? "";
      document.getElementById("unidade_2").value = data.unidade_2 ?? "";
      garantirSemDuplicar();

      // carrega conversão salva
      // default: 1 (pra não ficar vazio)
      document.getElementById("conv_m_por_pcs").value = data.conv_m_por_pcs ?? 1;

      const horas = data.horas_turno || [];
      const metas = data.meta_por_hora || [];

      // NOVO: dados da hora atual
      const idxHoraAtual = data.ultima_hora;
      const produzidoHora = data.producao_hora ?? 0;

      let tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";

      for(let i = 0; i < horas.length; i++){
        let tr = document.createElement("tr");

        let tdHora = document.createElement("td");
        tdHora.textContent = horas[i];

        let tdMeta = document.createElement("td");
        tdMeta.textContent = metas[i];

        // NOVO: Produzido Hora
        let tdProduzidoHora = document.createElement("td");
        tdProduzidoHora.textContent = (i === idxHoraAtual) ? produzidoHora : "—";

        // NOVO: Refugo Hora (por enquanto 0)
        let tdRefugoHora = document.createElement("td");
        tdRefugoHora.textContent = 0;

        tr.appendChild(tdHora);
        tr.appendChild(tdMeta);
        tr.appendChild(tdProduzidoHora);
        tr.appendChild(tdRefugoHora);

        tbody.appendChild(tr);
      }
    });
}

carregarTabela();
</script>

{% endblock %}
