{% extends "base.html" %}
{% block title %}Configurar Máquina{% endblock %}

{% block content %}

<style>
  .config-wrapper{
    width:100%;
    max-width:900px;
    margin:0 auto;
    background:#ffffff;
    padding:28px;
    border-radius:16px;
    box-shadow:0 4px 14px rgba(0,0,0,0.10);
    border:1px solid #e5e7eb;
  }

  h2{
    margin-top:0;
    font-size:24px;
    font-weight:700;
    color:#0f172a;
  }

  .input-row{
    display:flex;
    gap:16px;
    margin-bottom:16px;
  }

  .input-group{
    flex:1;
    display:flex;
    flex-direction:column;
  }

  .input-group label{
    font-size:14px;
    margin-bottom:4px;
    color:#334155;
  }

  .input-group input{
    padding:10px;
    border:1px solid #cbd5e1;
    border-radius:8px;
    font-size:16px;
  }

  .btn{
    margin-top:20px;
    padding:12px 20px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
    font-weight:600;
    color:white;
    background:#0f172a;
    transition:0.2s;
  }

  .btn:hover{
    background:#1e293b;
  }

  .turno-block{
    margin-top:32px;
    padding:18px;
    border-radius:12px;
    border:1px solid #e2e8f0;
    background:#f8fafc;
  }

  .turno-block h3{
    margin:0 0 10px 0;
    font-size:18px;
    font-weight:700;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
  }

  table th, table td{
    border:1px solid #cbd5e1;
    padding:10px;
    text-align:center;
  }

  table th{
    background:#e2e8f0;
    font-weight:700;
  }
</style>

<div class="config-wrapper">

  <h2>Configuração da Máquina – {{ machine.nome }}</h2>

  <!-- CAMPOS DO FORM -->
  <div class="input-row">
    <div class="input-group">
      <label>Rampa Inicial (%)</label>
      <input id="rampa" type="number" min="0" max="90" value="50">
    </div>
  </div>

  <!-- TURNO 1 -->
  <div class="turno-block">
    <h3>Turno 1</h3>
    <div class="input-row">
      <div class="input-group">
        <label>Início</label>
        <input id="t1_ini" type="time" value="06:00">
      </div>
      <div class="input-group">
        <label>Fim</label>
        <input id="t1_fim" type="time" value="16:00">
      </div>
      <div class="input-group">
        <label>Meta (peças)</label>
        <input id="t1_meta" type="number" value="1000">
      </div>
    </div>

    <div id="tabela_turno1"></div>
  </div>

  <!-- TURNO 2 -->
  <div class="turno-block">
    <h3>Turno 2</h3>
    <div class="input-row">
      <div class="input-group">
        <label>Início</label>
        <input id="t2_ini" type="time">
      </div>
      <div class="input-group">
        <label>Fim</label>
        <input id="t2_fim" type="time">
      </div>
      <div class="input-group">
        <label>Meta (peças)</label>
        <input id="t2_meta" type="number" value="0">
      </div>
    </div>

    <div id="tabela_turno2"></div>
  </div>

  <!-- TURNO 3 -->
  <div class="turno-block">
    <h3>Turno 3</h3>
    <div class="input-row">
      <div class="input-group">
        <label>Início</label>
        <input id="t3_ini" type="time">
      </div>
      <div class="input-group">
        <label>Fim</label>
        <input id="t3_fim" type="time">
      </div>
      <div class="input-group">
        <label>Meta (peças)</label>
        <input id="t3_meta" type="number" value="0">
      </div>
    </div>

    <div id="tabela_turno3"></div>
  </div>

  <button class="btn" onclick="calcular()">CALCULAR METAS</button>
  <button class="btn" style="background:#16a34a" onclick="salvar()">SALVAR CONFIGURAÇÃO</button>

</div>

<script>

function rangeHoras(inicio, fim){
  let horas = [];
  let hi = parseInt(inicio.split(":")[0]);
  let hf = parseInt(fim.split(":")[0]);

  if(hf <= hi){ hf += 24; }

  for(let h = hi; h < hf; h++){
    horas.push({ ini:h, fim:h+1 });
  }

  return horas;
}

function calculaTabela(turno, meta, rampa, idTabela){
  if(!turno.ini || !turno.fim || meta <= 0){
    document.getElementById(idTabela).innerHTML = "";
    return;
  }

  const horas = rangeHoras(turno.ini, turno.fim);

  if(horas.length === 0){
    document.getElementById(idTabela).innerHTML = "";
    return;
  }

  const primeiraHora = Math.floor(meta * (rampa/100));
  const restante = meta - primeiraHora;
  const metaHoraBase = Math.floor(restante / (horas.length - 1));
  
  let tabela = `
    <table>
      <tr><th>Hora</th><th>Meta</th></tr>
      <tr><td>${horas[0].ini}:00 - ${horas[0].fim}:00</td><td>${primeiraHora}</td></tr>
  `;

  let acumulado = primeiraHora;

  for(let i = 1; i < horas.length; i++){
    let val = metaHoraBase;
    if(i === horas.length - 1){
      val = meta - acumulado;
    }
    acumulado += val;

    tabela += `
      <tr>
        <td>${horas[i].ini}:00 - ${horas[i].fim}:00</td>
        <td>${val}</td>
      </tr>
    `;
  }

  tabela += "</table>";
  document.getElementById(idTabela).innerHTML = tabela;
}

function calcular(){
  const rampa = parseInt(document.getElementById("rampa").value);

  calculaTabela(
    { ini: t1_ini.value, fim: t1_fim.value },
    parseInt(t1_meta.value),
    rampa,
    "tabela_turno1"
  );

  calculaTabela(
    { ini: t2_ini.value, fim: t2_fim.value },
    parseInt(t2_meta.value),
    rampa,
    "tabela_turno2"
  );

  calculaTabela(
    { ini: t3_ini.value, fim: t3_fim.value },
    parseInt(t3_meta.value),
    rampa,
    "tabela_turno3"
  );
}

function salvar(){
  alert("Depois conectamos isso ao server.py ❤️");
}

</script>

{% endblock %}
