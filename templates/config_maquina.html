<!--
Caminho: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\templates\config_maquina.html
Ultimo recode: 2026-02-21 09:17 (America/Bahia)
Motivo: Atualizar navbar desta pagina para o modelo atual (Dashboard/Indicadores/Configuracoes/Admin/Sair). Manter OP em modal e cards.
-->

<!--
Arquivo: templates/base.html
Alterado em: 2026-02-01 18:55 (America/Bahia)
Por: ChatGPT
Motivo: Forcar layout desktop em celular/tablet (viewport width fixo) para telas iguais ao PC.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1200, initial-scale=1.0">
  <title>Maquina</title>
  <link rel="stylesheet" href="/static/style.css?v=2">

  <style>
    html, body{
      min-width:1200px;
      overflow-x:auto;
    }

    .navbar{
      width:100%;
      height:76px;
      background:#ffffff;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 24px;
      box-sizing:border-box;
      position:sticky;
      top:0;
      z-index:10;
    }

    .nav-left{
      display:flex;
      align-items:center;
      gap:14px;
    }

    .logo{
      height:56px;
      width:auto;
    }

    .system-name{
      font-size:20px;
      font-weight:600;
      color:#0f172a;
    }

    .nav-links{
      display:flex;
      align-items:center;
      gap:18px;
    }

    .nav-links a{
      text-decoration:none;
      font-size:15px;
      color:#334155;
      font-weight:500;
    }

    .nav-links a:hover{
      color:#0f172a;
    }

    .content-area{
      padding:24px;
      width:100%;
      box-sizing:border-box;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
    }

    .top-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }

    .op-ativo-box{
      cursor:pointer;
      user-select:none;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:8px 10px;
      background:#f8fafc;
      min-width:220px;
    }
    .op-ativo-title{
      font-size:12px;
      font-weight:900;
      color:#334155;
      text-transform:uppercase;
      letter-spacing:0.03em;
      margin-bottom:2px;
    }
    .op-ativo-info{
      font-size:13px;
      font-weight:900;
      color:#0f172a;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .cards-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
      margin-top:18px;
    }

    .machine-card{
      background:#ffffff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:18px;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
    }

    .machine-card-title{
      font-size:18px;
      font-weight:900;
      color:#0f172a;
      margin:0 0 8px 0;
    }

    .machine-card-desc{
      font-size:14px;
      color:#64748b;
      margin:0 0 14px 0;
      line-height:1.35;
      min-height:38px;
    }

    .machine-card-actions{
      display:flex;
      gap:10px;
    }

    @media (max-width: 1240px){
      .cards-grid{
        grid-template-columns: 1fr;
      }
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:640px;
      background:#fff;
      border-radius:18px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(0,0,0,0.18);
      overflow:hidden;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid #e5e7eb;
      background:#f8fafc;
    }
    .modal-title{
      font-size:14px;
      font-weight:900;
      color:#0f172a;
    }
    .modal-close{
      border:1px solid #e5e7eb;
      background:#fff;
      border-radius:10px;
      width:34px;
      height:34px;
      font-size:16px;
      line-height:32px;
      text-align:center;
      cursor:pointer;
    }
    .modal-body{
      padding:16px;
      max-height:80vh;
      overflow-y:auto;
    }

    .help-text{
      font-size:13px;
      color:#64748b;
      margin-top:6px;
      line-height:1.3;
    }
  </style>

</head>

<body>

  <nav class="navbar">
    <div class="nav-left">
      <img src="/static/img/logo.png" alt="NettSan Technology" class="logo">
      <span class="system-name">IndFlow</span>
    </div>

    <div class="nav-links">
      <a href="/">Dashboard</a>
      <a href="/indicadores">Indicadores</a>
      <a href="/configuracoes">Configuracoes</a>
      <a href="/admin">Admin</a>
      <a href="/admin/logout">Sair</a>
    </div>
  </nav>

  <main class="content-area">
    <div class="container">

      <div class="top-row">
        <h1 class="section-title" id="titulo-maquina">MAQUINA</h1>

        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <div id="op-ativo-box" class="op-ativo-box" style="display:none;">
            <div class="op-ativo-title">OP ativa</div>
            <div id="op-ativo-info" class="op-ativo-info">-</div>
          </div>
        </div>
      </div>

      <div class="cards-grid">

        <div class="machine-card">
          <div class="machine-card-title">OP</div>
          <p class="machine-card-desc">Abrir, editar ou encerrar Ordem de Produção da máquina.</p>
          <div class="machine-card-actions">
            <button id="btn-op-manage" type="button" class="btn btn-primary">Abrir</button>
          </div>
        </div>

        <div class="machine-card">
          <div class="machine-card-title">Historico</div>
          <p class="machine-card-desc">Consultar histórico de produção e desempenho por período.</p>
          <div class="machine-card-actions">
            <a id="link-historico" href="#" class="btn btn-primary">Abrir</a>
          </div>
        </div>

        <div class="machine-card">
          <div class="machine-card-title">Chamados</div>
          <p class="machine-card-desc">Abrir, acompanhar e encerrar chamados da máquina.</p>
          <div class="machine-card-actions">
            <a id="link-chamados" href="#" class="btn btn-primary">Abrir</a>
          </div>
        </div>

        <div class="machine-card">
          <div class="machine-card-title">Configuracao</div>
          <p class="machine-card-desc">Editar metas, turnos, conversões e parâmetros da máquina.</p>
          <div class="machine-card-actions">
            <a id="link-config" href="#" class="btn btn-primary">Abrir</a>
          </div>
        </div>

      </div>

      <div class="modal-backdrop" id="opModalBackdrop" style="display:none;">
        <div class="modal">
          <div class="modal-header">
            <div class="modal-title" id="opModalTitle">Ordem de Producao (OP)</div>
            <button class="modal-close" id="btnCloseOpModal" type="button" aria-label="Fechar">x</button>
          </div>
          <div class="modal-body">
            <form id="op-form">
              <label>OS:</label><input type="text" id="op_os" class="input" required>
              <label class="mt-20">Lote:</label><input type="text" id="op_lote" class="input" required>
              <label class="mt-20">Operador:</label><input type="text" id="op_operador" class="input" required>

              <label class="mt-20">Bobinas (opcional):</label>
              <div class="help-text">Adicione uma ou mais bobinas em metros (somente numeros). Se ficar vazio, nenhuma bobina sera registrada.</div>
              <div id="op_bobinas_list" style="display:flex; flex-direction:column; gap:10px; margin-top:10px;"></div>
              <button id="btnAddBobina" type="button" class="btn btn-secondary" style="margin-top:10px;">Adicionar bobina</button>
              <input type="hidden" id="op_bobina" value="">

              <label class="mt-20">GR / Fio (opcional):</label><input type="text" id="op_gr_fio" class="input">
              <label class="mt-20">Observacoes (opcional):</label><textarea id="op_obs" class="input" rows="3" style="resize:vertical;"></textarea>

              <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:18px; flex-wrap:wrap;">
                <button type="button" class="btn btn-secondary" id="btnCancelOp">Cancelar</button>
                <button type="button" class="btn" id="btnEndOpInside" style="background:#0f172a;color:#fff; display:none;">Encerrar OP</button>
                <button type="submit" class="btn btn-primary" id="btnSaveOp">Salvar</button>
              </div>
            </form>
            <div class="help-text" style="margin-top:10px;">Inicio e fim da OP sao automaticos (ao iniciar e encerrar).</div>
          </div>
        </div>
      </div>

    </div>
  </main>

<script>
const machine_id = window.location.pathname.split("/").pop();

document.getElementById("titulo-maquina").textContent = machine_id.toUpperCase();
document.title = machine_id.toUpperCase();

document.getElementById("link-historico").href = `/maquina/${encodeURIComponent(machine_id)}/historico`;
document.getElementById("link-chamados").href = `/maquina/${encodeURIComponent(machine_id)}/chamados`;
document.getElementById("link-config").href = `/maquina/${encodeURIComponent(machine_id)}/configuracao`;

let opAtiva = null;
let opModalMode = "new";

function _createBobinaRow(value){
  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.gap = "10px";
  row.style.alignItems = "center";

  const inp = document.createElement("input");
  inp.type = "number";
  inp.min = "0";
  inp.step = "1";
  inp.className = "input";
  inp.placeholder = "Metros";
  inp.value = String(value || "");
  inp.style.flex = "1";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "btn btn-secondary";
  btn.textContent = "Remover";
  btn.addEventListener("click", () => { row.remove(); _syncHiddenBobinaFirst(); });

  row.appendChild(inp);
  row.appendChild(btn);
  return row;
}

function _getBobinasFromUI(){
  const list = document.getElementById("op_bobinas_list");
  if(!list) return [];
  const out = [];
  const rows = list.querySelectorAll("div");
  rows.forEach((r) => {
    const inp = r.querySelector("input");
    const v = String((inp && inp.value) ? inp.value : "").trim();
    if(v) out.push(v);
  });
  return out;
}

function _setBobinasToUI(arr){
  const list = document.getElementById("op_bobinas_list");
  if(!list) return;
  list.innerHTML = "";
  const a = Array.isArray(arr) ? arr : [];
  if(a.length === 0){
    list.appendChild(_createBobinaRow(""));
    return;
  }
  a.forEach((v) => { list.appendChild(_createBobinaRow(v)); });
}

function _syncHiddenBobinaFirst(){
  const h = document.getElementById("op_bobina");
  if(!h) return;
  const bobinas = _getBobinasFromUI();
  h.value = bobinas.length ? bobinas[0] : "";
}

function _fillOpFormFromData(d){
  document.getElementById("op_os").value = String(d.os || "");
  document.getElementById("op_lote").value = String(d.lote || "");
  document.getElementById("op_operador").value = String(d.operador || "");
  document.getElementById("op_gr_fio").value = String(d.gr_fio || "");
  document.getElementById("op_obs").value = String(d.observacoes || "");

  const bobinas =
    Array.isArray(d.bobinas) ? d.bobinas :
    (d.bobina ? [String(d.bobina)] : []);
  _setBobinasToUI(bobinas);
  _syncHiddenBobinaFirst();
}

function _setOpTopBox(info){
  const box = document.getElementById("op-ativo-box");
  const i = document.getElementById("op-ativo-info");
  if(!box || !i) return;
  if(info){
    box.style.display = "block";
    i.textContent = info;
  }else{
    box.style.display = "none";
    i.textContent = "-";
  }
}

async function _getJson(url){
  try{
    const r = await fetch(url);
    if(!r.ok) return null;
    return await r.json();
  }catch(e){
    return null;
  }
}

function _normalizeMachineStatusPayload(payload){
  if(payload && typeof payload === "object" && payload.machine_status){
    return { machine: payload.machine_status, op: (payload.op_status || null) };
  }
  return { machine: payload, op: null };
}

async function carregarOpStatus(){
  const payload = await _getJson(`/machine/status?machine_id=${encodeURIComponent(machine_id)}`);
  if(payload){
    const norm = _normalizeMachineStatusPayload(payload);
    if(norm.op && norm.op.active){
      opAtiva = norm.op;
      const info = `OS ${String(opAtiva.os||"")} | Lote ${String(opAtiva.lote||"")} | Operador ${String(opAtiva.operador||"")}`;
      _setOpTopBox(info);
      return;
    }
  }

  const d = await _getJson(`/producao/op/status?machine_id=${encodeURIComponent(machine_id)}`);
  if(d && d.active){
    opAtiva = d;
    const info = `OS ${String(d.os||"")} | Lote ${String(d.lote||"")} | Operador ${String(d.operador||"")}`;
    _setOpTopBox(info);
  }else{
    opAtiva = null;
    _setOpTopBox(null);
  }
}

function _setModalMode(mode){
  opModalMode = (mode === "edit") ? "edit" : "new";
  const t = document.getElementById("opModalTitle");
  const btnSave = document.getElementById("btnSaveOp");
  const btnEnd = document.getElementById("btnEndOpInside");

  if(opModalMode === "edit"){
    if(t) t.textContent = "Editar Ordem de Producao (OP)";
    if(btnSave) btnSave.textContent = "Salvar Alteracoes";
    if(btnEnd) btnEnd.style.display = "inline-block";
  }else{
    if(t) t.textContent = "Nova Ordem de Producao (OP)";
    if(btnSave) btnSave.textContent = "Iniciar OP";
    if(btnEnd) btnEnd.style.display = "none";
  }
}

function openOpModal(){
  if(opAtiva && opAtiva.active){
    _setModalMode("edit");
    _fillOpFormFromData(opAtiva);
  }else{
    _setModalMode("new");
    document.getElementById("op-form").reset();
    _setBobinasToUI([]);
    _syncHiddenBobinaFirst();
  }

  const bd = document.getElementById("opModalBackdrop");
  if(bd) bd.style.display = "flex";
}

function closeOpModal(){
  const bd = document.getElementById("opModalBackdrop");
  if(bd) bd.style.display = "none";
}

async function _postJson(url,p){
  const r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
  let j = null;
  try{ j = await r.json(); }catch(e){}
  if(!r.ok){ throw new Error((j && j.error) ? j.error : "Falha na requisicao"); }
  return j;
}

function initOpUI(){
  const btnManage = document.getElementById("btn-op-manage");
  const box = document.getElementById("op-ativo-box");

  if(btnManage) btnManage.addEventListener("click", openOpModal);
  if(box) box.addEventListener("click", openOpModal);

  const bd = document.getElementById("opModalBackdrop");
  const bc = document.getElementById("btnCloseOpModal");
  const bx = document.getElementById("btnCancelOp");
  if(bc) bc.addEventListener("click", closeOpModal);
  if(bx) bx.addEventListener("click", closeOpModal);
  if(bd) bd.addEventListener("click", (e) => { if(e && e.target === bd) closeOpModal(); });

  const btnAdd = document.getElementById("btnAddBobina");
  if(btnAdd) btnAdd.addEventListener("click", () => {
    const list = document.getElementById("op_bobinas_list");
    if(!list) return;
    list.appendChild(_createBobinaRow(""));
    _syncHiddenBobinaFirst();
  });

  const list = document.getElementById("op_bobinas_list");
  if(list){
    list.addEventListener("input", () => { _syncHiddenBobinaFirst(); });
    list.addEventListener("change", () => { _syncHiddenBobinaFirst(); });
  }

  const btnEnd = document.getElementById("btnEndOpInside");
  if(btnEnd) btnEnd.addEventListener("click", async () => {
    if(!opAtiva || !opAtiva.active){
      alert("Nao ha OP ativa para encerrar.");
      return;
    }
    if(!confirm("Confirmar encerramento da OP ativa?")) return;

    try{
      await _postJson("/producao/op/encerrar", {machine_id: machine_id});
      closeOpModal();
      await carregarOpStatus();
    }catch(err){
      alert(String(err && err.message ? err.message : err));
    }
  });

  const f = document.getElementById("op-form");
  if(f) f.addEventListener("submit", async (e) => {
    e.preventDefault();

    const os = String(document.getElementById("op_os").value || "").trim();
    const lote = String(document.getElementById("op_lote").value || "").trim();
    const oper = String(document.getElementById("op_operador").value || "").trim();
    if(!os || !lote || !oper){
      alert("Preencha OS, Lote e Operador.");
      return;
    }

    const payload = {
      machine_id: machine_id,
      os: os,
      lote: lote,
      operador: oper,
      bobina: String(document.getElementById("op_bobina").value || "").trim(),
      gr_fio: String(document.getElementById("op_gr_fio").value || "").trim(),
      observacoes: String(document.getElementById("op_obs").value || "").trim()
    };

    try{
      const bobinas = _getBobinasFromUI();
      payload.bobinas = bobinas;
      payload.bobina = bobinas.length ? bobinas[0] : payload.bobina;

      if(opModalMode === "edit"){
        await _postJson("/producao/op/editar", payload);
      }else{
        await _postJson("/producao/op/iniciar", payload);
      }

      closeOpModal();
      await carregarOpStatus();
    }catch(err){
      alert(String(err && err.message ? err.message : err));
    }
  });
}

initOpUI();
carregarOpStatus();
</script>

</body>
</html>
