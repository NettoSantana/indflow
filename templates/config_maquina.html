{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}

{% block content %}

<div class="container">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

    <div style="display:flex; gap:10px;">
      <a id="btn-historico" href="#" class="btn btn-secondary">Histórico</a>
      <button id="btn-reset" class="btn" style="background:#dc2626;color:#fff;">
        Zerar Produção
      </button>
    </div>
  </div>

  <div class="card">

    <form id="config-form">

      <!-- META DO TURNO -->
      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <!-- UNIDADE DE PRODUÇÃO -->
      <label class="mt-20">Unidade de Produção (até 2):</label>
      <div class="row">
        <div class="col">
          <select id="unidade_1" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
        <div class="col">
          <select id="unidade_2" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
      </div>

      <!-- CONVERSÃO -->
      <label class="mt-20">Conversão física da máquina:</label>
      <small style="color:#64748b;">
        1 peça equivale a quantos metros lineares?
      </small>
      <input
        type="number"
        step="0.001"
        min="0.001"
        id="conv_m_por_pcs"
        placeholder="Ex: 0,85"
        required
      >

      <!-- HORÁRIOS -->
      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>
        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <!-- RAMPA -->
      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">
        Salvar Configuração
      </button>
    </form>

  </div>

  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const machine_id = window.location.pathname.split("/").pop();

document.getElementById("titulo-maquina").textContent =
  "Configuração da Máquina — " + machine_id.toUpperCase();

document.getElementById("btn-historico").href =
  `/producao/historico?machine_id=${machine_id}`;

// RESET
document.getElementById("btn-reset").addEventListener("click", () => {
  if (!confirm("CONFIRMAR RESET DA PRODUÇÃO?")) return;
  fetch("/admin/reset-manual", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ machine_id })
  }).then(() => {
    alert("Produção zerada.");
    carregarTabela();
  });
});

// NÃO DUPLICAR UNIDADES
function garantirSemDuplicar(){
  const u1 = unidade_1.value;
  if (u1 && u1 === unidade_2.value) unidade_2.value = "";
}
unidade_1.onchange = garantirSemDuplicar;
unidade_2.onchange = garantirSemDuplicar;

// SUBMIT
document.getElementById("config-form").addEventListener("submit", e => {
  e.preventDefault();
  garantirSemDuplicar();

  fetch("/machine/config", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id,
      meta_turno: meta.value,
      inicio: inicio.value,
      fim: fim.value,
      rampa: rampa.value,
      unidade_1: unidade_1.value,
      unidade_2: unidade_2.value,
      conv_m_por_pcs: conv_m_por_pcs.value
    })
  }).then(() => {
    alert("Configuração salva com sucesso.");
    carregarTabela();
  });
});

// STATUS
function carregarTabela(){
  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {
      unidade_1.value = data.unidade_1 ?? "";
      unidade_2.value = data.unidade_2 ?? "";
      conv_m_por_pcs.value = data.conv_m_por_pcs ?? 1;

      const tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";
      (data.horas_turno || []).forEach((h, i) => {
        tbody.innerHTML += `<tr><td>${h}</td><td>${data.meta_por_hora[i]}</td></tr>`;
      });
    });
}

carregarTabela();
</script>

{% endblock %}
