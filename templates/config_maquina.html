{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}

{% block content %}

<style>
  /* TABELA ZEBRADA */
  #tabela-horas tbody tr:nth-child(even) { background-color: #f3f4f6; }
  #tabela-horas tbody tr:nth-child(odd) { background-color: #ffffff; }
  #tabela-horas tbody tr:hover { background-color: #e5e7eb; }

  /* DESTAQUE: TURNO ATIVO (linha dentro do intervalo início->fim)
     Azul claro + branco, com "duas faixas" (topo mais claro / base mais azul). */
  #tabela-horas tbody tr.turno-ativo{
    background-color:#e0f2fe; /* fallback */
    background-image:linear-gradient(180deg, #ffffff 0%, #e0f2fe 100%);
    border-top:1px solid #ffffff;
    border-bottom:1px solid #bfdbfe;
  }
  #tabela-horas tbody tr.turno-ativo:hover{
    background-color:#bae6fd; /* fallback */
    background-image:linear-gradient(180deg, #f0f9ff 0%, #bae6fd 100%);
  }

  /* REFUGO EDITÁVEL */
  .refugo-input{
    width: 90px;
    padding: 6px 8px;
    border: 1px solid #cbd5e1;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
    background: #ffffff;
  }
  .refugo-input:focus{
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.20);
  }
  .refugo-input:disabled{
    background: #e5e7eb;
    color: #64748b;
    cursor: not-allowed;
  }
</style>

<div class="container">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

    <div style="display:flex; gap:10px;">
      <a id="btn-historico" href="#" class="btn btn-secondary">Histórico</a>

      <button id="btn-reset" class="btn" style="background:#dc2626;color:#fff;">
        Zerar Produção
      </button>
    </div>
  </div>

  <div class="card">
    <form id="config-form">

      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <label class="mt-20">Unidade de Produção (até 2):</label>

      <div class="row">
        <div class="col">
          <select id="unidade_1" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>

        <div class="col">
          <select id="unidade_2" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
      </div>

      <label class="mt-20">Conversão (1 pcs = X metros):</label>
      <input
        type="number"
        id="conv_m_por_pcs"
        class="input"
        step="0.001"
        min="0.001"
        placeholder="Ex: 0.85"
        required
      >

      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>

        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">
        Salvar Configuração
      </button>
    </form>
  </div>

  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>
          <th>Produzido Hora</th>
          <th>Refugo Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const machine_id = window.location.pathname.split("/").pop();

document.getElementById("titulo-maquina").textContent =
  "Configuração da Máquina — " + machine_id.toUpperCase();

document.getElementById("btn-historico").href =
  `/producao/historico?machine_id=${machine_id}`;

// ===============================
// TABELA FIXA 24H
// ===============================
function pad2(n){ return String(n).padStart(2, "0"); }

function buildFaixas24(){
  const out = [];
  for(let h = 0; h < 24; h++){
    const h2 = (h + 1) % 24;
    out.push(`${pad2(h)}:00–${pad2(h2)}:00`);
  }
  return out;
}

const HORAS_FIXAS_24 = buildFaixas24();

// ===============================
// TIME HELPERS
// ===============================
function parseHourFromTimeStr(s){
  if(!s || typeof s !== "string") return null;
  const parts = s.split(":");
  const h = Number(parts[0]);
  if(!Number.isFinite(h) || h < 0 || h > 23) return null;
  return h;
}

function parseMinFromTimeStr(s){
  if(!s || typeof s !== "string") return null;
  const parts = s.split(":");
  const h = Number(parts[0]);
  const m = Number(parts[1] ?? 0);
  if(!Number.isFinite(h) || h < 0 || h > 23) return null;
  if(!Number.isFinite(m) || m < 0 || m > 59) return null;
  return h * 60 + m;
}

function horaDentroDoTurno(horaIndex, inicioStr, fimStr){
  const ini = parseMinFromTimeStr(inicioStr);
  const fim = parseMinFromTimeStr(fimStr);
  if(ini === null || fim === null) return false;

  const t = horaIndex * 60;

  if(ini < fim){
    return (t >= ini) && (t < fim);
  }

  if(ini > fim){
    return (t >= ini) || (t < fim);
  }

  return false;
}

// ===============================
// MAP TURNO -> 24H (meta e produzido)
// ===============================
function mapTurnoListPara24h(lista_turno, inicioStr, fillValue){
  const out = new Array(24).fill(fillValue);

  const inicioHour = parseHourFromTimeStr(inicioStr);
  if(inicioHour === null) return out;

  const arr = Array.isArray(lista_turno) ? lista_turno : [];
  for(let i = 0; i < arr.length; i++){
    const hour = (inicioHour + i) % 24;
    out[hour] = arr[i];
  }
  return out;
}

function turnoIdxParaHoraDoDia(turnoIdx, inicioStr){
  const inicioHour = parseHourFromTimeStr(inicioStr);
  if(inicioHour === null) return null;
  if(typeof turnoIdx !== "number" || !Number.isFinite(turnoIdx)) return null;
  return (inicioHour + turnoIdx) % 24;
}

function toNonNegInt(v){
  const n = Number(v);
  if(!Number.isFinite(n) || n < 0) return 0;
  return Math.floor(n);
}

// ===============================
// API: SALVAR REFUGO (SQLITE)
// ===============================
function salvarRefugoAPI(machineId, diaRef, horaDia, refugo){
  return fetch("/machine/refugo", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id: machineId,
      dia_ref: diaRef,
      hora_dia: horaDia,
      refugo: refugo
    })
  })
  .then(async (r) => {
    let payload = null;
    try{ payload = await r.json(); }catch(e){}
    if(!r.ok){
      const msg = (payload && payload.error) ? payload.error : "Erro ao salvar refugo";
      throw new Error(msg);
    }
    return payload;
  });
}

// ===============================
// RESET MANUAL
// ===============================
document.getElementById("btn-reset").addEventListener("click", function(){
  if(!confirm("CONFIRMAR RESET DA PRODUÇÃO?\nEssa ação grava histórico e zera os contadores.")){
    return;
  }

  fetch("/admin/reset-manual", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ machine_id })
  })
  .then(r => r.json())
  .then(() => {
    alert("Produção zerada com sucesso.");
    carregarTabela();
  });
});

// ===============================
// UNIDADES: não permitir duplicado
// ===============================
function garantirSemDuplicar(){
  const u1 = document.getElementById("unidade_1");
  const u2 = document.getElementById("unidade_2");
  if(u1.value && u2.value && u1.value === u2.value){
    u2.value = "";
  }
}
document.getElementById("unidade_1").addEventListener("change", garantirSemDuplicar);
document.getElementById("unidade_2").addEventListener("change", garantirSemDuplicar);

// ===============================
// SUBMIT DO FORMULÁRIO
// ===============================
document.getElementById("config-form").addEventListener("submit", function(e){
  e.preventDefault();

  garantirSemDuplicar();

  const conv = Number(document.getElementById("conv_m_por_pcs").value);
  if(!Number.isFinite(conv) || conv <= 0){
    alert("Conversão inválida. Use um número maior que zero. Ex: 0.85");
    return;
  }

  fetch("/machine/config", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id: machine_id,
      meta_turno: document.getElementById("meta").value,
      inicio: document.getElementById("inicio").value,
      fim: document.getElementById("fim").value,
      rampa: document.getElementById("rampa").value,
      unidade_1: document.getElementById("unidade_1").value,
      unidade_2: document.getElementById("unidade_2").value,
      conv_m_por_pcs: document.getElementById("conv_m_por_pcs").value
    })
  })
  .then(r => r.json())
  .then(() => {
    alert("Configuração salva com sucesso!");
    carregarTabela();
  });
});

// ===============================
// BUSCAR STATUS + TABELA (FIXA 24H)
// ===============================
function carregarTabela(){
  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {

      document.getElementById("unidade_1").value = data.unidade_1 ?? "";
      document.getElementById("unidade_2").value = data.unidade_2 ?? "";
      garantirSemDuplicar();

      document.getElementById("conv_m_por_pcs").value = data.conv_m_por_pcs ?? 1;

      if(data.turno_inicio) document.getElementById("inicio").value = data.turno_inicio;
      if(data.turno_fim) document.getElementById("fim").value = data.turno_fim;
      if(data.meta_turno !== undefined && data.meta_turno !== null) document.getElementById("meta").value = data.meta_turno;
      if(data.rampa_percentual !== undefined && data.rampa_percentual !== null) document.getElementById("rampa").value = data.rampa_percentual;

      const inicioTurnoStr = (data.turno_inicio ?? document.getElementById("inicio").value);
      const fimTurnoStr = (data.turno_fim ?? document.getElementById("fim").value);

      const meta24 = mapTurnoListPara24h(data.meta_por_hora, inicioTurnoStr, 0);

      // ⚠️ PRODUÇÃO: ainda vem do backend como lista do TURNO.
      // Para não "sumir" hora extra/fora do turno na tabela, a UI passa a mostrar 0
      // (horas passadas sem dado) e mantém "—" apenas para horas futuras.
      const produzido24 = mapTurnoListPara24h(data.producao_por_hora, inicioTurnoStr, null);

      const horaDiaAtual =
        (typeof data.ultima_hora === "number")
          ? (turnoIdxParaHoraDoDia(data.ultima_hora, inicioTurnoStr) ?? new Date().getHours())
          : new Date().getHours();

      const produzidoHoraAtual = data.producao_hora ?? 0;

      const diaRef = data.ultimo_dia ?? (data.dia_ref ?? "sem_dia");
      const refugo24 = Array.isArray(data.refugo_por_hora) ? data.refugo_por_hora : new Array(24).fill(0);

      const tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";

      for(let i = 0; i < 24; i++){
        const tr = document.createElement("tr");

        if(horaDentroDoTurno(i, inicioTurnoStr, fimTurnoStr)){
          tr.classList.add("turno-ativo");
        }

        const tdHora = document.createElement("td");
        tdHora.textContent = HORAS_FIXAS_24[i];

        const tdMeta = document.createElement("td");
        tdMeta.textContent = meta24[i] ?? 0;

        let baseVal = null;
        const v = produzido24[i];

        // FUTURO: mantém "—"
        if (typeof horaDiaAtual === "number" && i > horaDiaAtual) {
          baseVal = null;
        } else if (v !== null && v !== undefined && v !== "") {
          baseVal = Number(v);
          if(!Number.isFinite(baseVal)) baseVal = null;
        } else if (i === horaDiaAtual) {
          baseVal = Number(produzidoHoraAtual);
          if(!Number.isFinite(baseVal)) baseVal = 0;
        } else {
          // ✅ PASSADO SEM DADO: mostra 0 (não some hora extra na tabela)
          baseVal = 0;
        }

        const ref = toNonNegInt(refugo24[i] ?? 0);

        const tdProduzidoHora = document.createElement("td");
        if(baseVal === null){
          tdProduzidoHora.textContent = "—";
        }else{
          tdProduzidoHora.textContent = Math.max(0, Math.floor(baseVal) - ref);
        }

        const tdRefugoHora = document.createElement("td");

        const input = document.createElement("input");
        input.type = "number";
        input.min = "0";
        input.step = "1";
        input.className = "refugo-input";
        input.value = ref;

        const podeEditar = (typeof horaDiaAtual === "number") ? (i < horaDiaAtual) : false;
        input.disabled = !podeEditar;

        input.addEventListener("blur", async () => {
          if(!podeEditar){
            input.value = toNonNegInt(refugo24[i] ?? 0);
            return;
          }

          const anterior = toNonNegInt(refugo24[i] ?? 0);
          const novo = toNonNegInt(input.value);

          if(novo === anterior){
            input.value = novo;
            return;
          }

          try{
            await salvarRefugoAPI(machine_id, diaRef, i, novo);

            refugo24[i] = novo;

            if(baseVal === null){
              tdProduzidoHora.textContent = "—";
            }else{
              tdProduzidoHora.textContent = Math.max(0, Math.floor(baseVal) - novo);
            }

            input.value = novo;
          }catch(err){
            alert(String(err && err.message ? err.message : err));

            input.value = anterior;
            if(baseVal === null){
              tdProduzidoHora.textContent = "—";
            }else{
              tdProduzidoHora.textContent = Math.max(0, Math.floor(baseVal) - anterior);
            }
          }
        });

        tdRefugoHora.appendChild(input);

        tr.appendChild(tdHora);
        tr.appendChild(tdMeta);
        tr.appendChild(tdProduzidoHora);
        tr.appendChild(tdRefugoHora);

        tbody.appendChild(tr);
      }
    });
}

carregarTabela();
</script>

{% endblock %}
