{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}
{% block content %}

<style>
  #tabela-horas tbody tr:nth-child(even){ background:#f3f4f6; }
  #tabela-horas tbody tr:nth-child(odd){ background:#fff; }
  #tabela-horas tbody tr:hover{ background:#e5e7eb; }
</style>

<div class="container">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

    <div style="display:flex; gap:10px;">
      <a id="btn-historico" href="#" class="btn btn-secondary">Histórico</a>
      <button id="btn-reset" class="btn" style="background:#dc2626;color:#fff;">Zerar Produção</button>
    </div>
  </div>

  <div class="card">
    <form id="config-form">
      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <label class="mt-20">Unidade de Produção (até 2):</label>
      <div class="row">
        <div class="col">
          <select id="unidade_1" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
        <div class="col">
          <select id="unidade_2" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
      </div>

      <label class="mt-20">Conversão (1 pcs = X metros):</label>
      <input type="number" id="conv_m_por_pcs" class="input" step="0.001" min="0.001" placeholder="Ex: 0.85" required>

      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>
        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">Salvar Configuração</button>
    </form>
  </div>

  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>
          <th>Produzido Hora</th>
          <th>Refugo Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const machine_id = window.location.pathname.split("/").pop();
const $ = (id) => document.getElementById(id);

$("titulo-maquina").textContent = "Configuração da Máquina — " + machine_id.toUpperCase();
$("btn-historico").href = `/producao/historico?machine_id=${machine_id}`;

function pad2(n){ return String(n).padStart(2,"0"); }
function faixas24(){
  const a = [];
  for(let h=0; h<24; h++){
    const h2 = (h+1)%24;
    a.push(`${pad2(h)}:00–${pad2(h2)}:00`);
  }
  return a;
}
const HORAS_FIXAS = faixas24();

$("btn-reset").addEventListener("click", () => {
  if(!confirm("CONFIRMAR RESET DA PRODUÇÃO?\nEssa ação grava histórico e zera os contadores.")) return;
  fetch("/admin/reset-manual", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ machine_id })
  })
  .then(r => r.json())
  .then(() => {
    alert("Produção zerada com sucesso.");
    carregarTabela();
  });
});

function garantirSemDuplicar(){
  const u1 = $("unidade_1"), u2 = $("unidade_2");
  if(u1.value && u2.value && u1.value === u2.value) u2.value = "";
}
$("unidade_1").addEventListener("change", garantirSemDuplicar);
$("unidade_2").addEventListener("change", garantirSemDuplicar);

$("config-form").addEventListener("submit", (e) => {
  e.preventDefault();
  garantirSemDuplicar();

  const conv = Number($("conv_m_por_pcs").value);
  if(!Number.isFinite(conv) || conv <= 0){
    alert("Conversão inválida. Use um número maior que zero. Ex: 0.85");
    return;
  }

  fetch("/machine/config", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      machine_id,
      meta_turno:$("meta").value,
      inicio:$("inicio").value,
      fim:$("fim").value,
      rampa:$("rampa").value,
      unidade_1:$("unidade_1").value,
      unidade_2:$("unidade_2").value,
      conv_m_por_pcs:$("conv_m_por_pcs").value
    })
  })
  .then(r => r.json())
  .then(() => {
    alert("Configuração salva com sucesso!");
    carregarTabela();
  });
});

function carregarTabela(){
  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {
      $("unidade_1").value = data.unidade_1 ?? "";
      $("unidade_2").value = data.unidade_2 ?? "";
      garantirSemDuplicar();
      $("conv_m_por_pcs").value = data.conv_m_por_pcs ?? 1;

      const metas = Array.isArray(data.meta_por_hora) ? data.meta_por_hora : [];
      const produzidos = Array.isArray(data.producao_por_hora) ? data.producao_por_hora : [];

      let idxHoraAtual = (typeof data.ultima_hora === "number" && data.ultima_hora >= 0 && data.ultima_hora <= 23)
        ? data.ultima_hora
        : new Date().getHours();

      const parcialHoraAtual = data.producao_hora ?? 0;

      const tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";

      for(let i=0; i<24; i++){
        const tr = document.createElement("tr");

        const tdHora = document.createElement("td");
        tdHora.textContent = HORAS_FIXAS[i];

        const tdMeta = document.createElement("td");
        tdMeta.textContent = metas[i] ?? 0;

        const tdProd = document.createElement("td");
        const v = produzidos[i];

        if(i > idxHoraAtual){
          tdProd.textContent = "—";
        } else if(v !== null && v !== undefined && v !== ""){
          tdProd.textContent = v;
        } else if(i === idxHoraAtual){
          tdProd.textContent = parcialHoraAtual;
        } else {
          tdProd.textContent = "—";
        }

        const tdRef = document.createElement("td");
        tdRef.textContent = 0;

        tr.appendChild(tdHora);
        tr.appendChild(tdMeta);
        tr.appendChild(tdProd);
        tr.appendChild(tdRef);
        tbody.appendChild(tr);
      }
    });
}
carregarTabela();
</script>

{% endblock %}
