{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}

{% block content %}

<style>
  /* TABELA ZEBRADA */
  #tabela-horas tbody tr:nth-child(even) { background-color: #f3f4f6; }
  #tabela-horas tbody tr:nth-child(odd) { background-color: #ffffff; }
  #tabela-horas tbody tr:hover { background-color: #e5e7eb; }

  /* DESTAQUE: TURNO ATIVO (linha dentro do intervalo início->fim) */
  #tabela-horas tbody tr.turno-ativo {
    background-color: #fff7ed; /* leve destaque */
  }
  #tabela-horas tbody tr.turno-ativo:hover {
    background-color: #ffedd5; /* hover do turno */
  }
</style>

<div class="container">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

    <div style="display:flex; gap:10px;">
      <a id="btn-historico" href="#" class="btn btn-secondary">Histórico</a>

      <button id="btn-reset" class="btn" style="background:#dc2626;color:#fff;">
        Zerar Produção
      </button>
    </div>
  </div>

  <div class="card">
    <form id="config-form">

      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <label class="mt-20">Unidade de Produção (até 2):</label>

      <div class="row">
        <div class="col">
          <select id="unidade_1" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>

        <div class="col">
          <select id="unidade_2" class="input">
            <option value="">—</option>
            <option value="pcs">Unidade (pcs)</option>
            <option value="m">Metro linear (m)</option>
            <option value="m2">Metro quadrado (m²)</option>
          </select>
        </div>
      </div>

      <label class="mt-20">Conversão (1 pcs = X metros):</label>
      <input
        type="number"
        id="conv_m_por_pcs"
        class="input"
        step="0.001"
        min="0.001"
        placeholder="Ex: 0.85"
        required
      >

      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>

        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">
        Salvar Configuração
      </button>
    </form>
  </div>

  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>
          <th>Produzido Hora</th>
          <th>Refugo Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const machine_id = window.location.pathname.split("/").pop();

document.getElementById("titulo-maquina").textContent =
  "Configuração da Máquina — " + machine_id.toUpperCase();

document.getElementById("btn-historico").href =
  `/producao/historico?machine_id=${machine_id}`;

// ===============================
// TABELA FIXA 24H
// ===============================
function pad2(n){ return String(n).padStart(2, "0"); }

function buildFaixas24(){
  const out = [];
  for(let h = 0; h < 24; h++){
    const h2 = (h + 1) % 24;
    out.push(`${pad2(h)}:00–${pad2(h2)}:00`);
  }
  return out;
}

const HORAS_FIXAS_24 = buildFaixas24();

// ===============================
// TIME HELPERS
// ===============================
function parseHourFromTimeStr(s){
  // "08:00" -> 8
  if(!s || typeof s !== "string") return null;
  const parts = s.split(":");
  const h = Number(parts[0]);
  if(!Number.isFinite(h) || h < 0 || h > 23) return null;
  return h;
}

function parseMinFromTimeStr(s){
  // "08:30" -> 510
  if(!s || typeof s !== "string") return null;
  const parts = s.split(":");
  const h = Number(parts[0]);
  const m = Number(parts[1] ?? 0);
  if(!Number.isFinite(h) || h < 0 || h > 23) return null;
  if(!Number.isFinite(m) || m < 0 || m > 59) return null;
  return h * 60 + m;
}

function horaDentroDoTurno(horaIndex, inicioStr, fimStr){
  const ini = parseMinFromTimeStr(inicioStr);
  const fim = parseMinFromTimeStr(fimStr);
  if(ini === null || fim === null) return false;

  const t = horaIndex * 60;

  // turno "normal" (08:00–16:00)
  if(ini < fim){
    return (t >= ini) && (t < fim);
  }

  // turno cruzando meia-noite (22:00–06:00)
  if(ini > fim){
    return (t >= ini) || (t < fim);
  }

  // ini == fim -> considerado "sem turno"
  return false;
}

// ===============================
// MAP TURN0 -> 24H (meta e produzido)
// ===============================
function mapTurnoListPara24h(lista_turno, inicioStr, fillValue){
  const out = new Array(24).fill(fillValue);

  const inicioHour = parseHourFromTimeStr(inicioStr);
  if(inicioHour === null) return out;

  const arr = Array.isArray(lista_turno) ? lista_turno : [];
  for(let i = 0; i < arr.length; i++){
    const hour = (inicioHour + i) % 24;
    out[hour] = arr[i];
  }
  return out;
}

function turnoIdxParaHoraDoDia(turnoIdx, inicioStr){
  const inicioHour = parseHourFromTimeStr(inicioStr);
  if(inicioHour === null) return null;
  if(typeof turnoIdx !== "number" || !Number.isFinite(turnoIdx)) return null;
  return (inicioHour + turnoIdx) % 24;
}

// ===============================
// RESET MANUAL
// ===============================
document.getElementById("btn-reset").addEventListener("click", function(){
  if(!confirm("CONFIRMAR RESET DA PRODUÇÃO?\nEssa ação grava histórico e zera os contadores.")){
    return;
  }

  fetch("/admin/reset-manual", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ machine_id })
  })
  .then(r => r.json())
  .then(() => {
    alert("Produção zerada com sucesso.");
    carregarTabela();
  });
});

// ===============================
// UNIDADES: não permitir duplicado
// ===============================
function garantirSemDuplicar(){
  const u1 = document.getElementById("unidade_1");
  const u2 = document.getElementById("unidade_2");
  if(u1.value && u2.value && u1.value === u2.value){
    u2.value = "";
  }
}
document.getElementById("unidade_1").addEventListener("change", garantirSemDuplicar);
document.getElementById("unidade_2").addEventListener("change", garantirSemDuplicar);

// ===============================
// SUBMIT DO FORMULÁRIO
// ===============================
document.getElementById("config-form").addEventListener("submit", function(e){
  e.preventDefault();

  garantirSemDuplicar();

  const conv = Number(document.getElementById("conv_m_por_pcs").value);
  if(!Number.isFinite(conv) || conv <= 0){
    alert("Conversão inválida. Use um número maior que zero. Ex: 0.85");
    return;
  }

  fetch("/machine/config", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id: machine_id,
      meta_turno: document.getElementById("meta").value,
      inicio: document.getElementById("inicio").value,
      fim: document.getElementById("fim").value,
      rampa: document.getElementById("rampa").value,
      unidade_1: document.getElementById("unidade_1").value,
      unidade_2: document.getElementById("unidade_2").value,
      conv_m_por_pcs: document.getElementById("conv_m_por_pcs").value
    })
  })
  .then(r => r.json())
  .then(() => {
    alert("Configuração salva com sucesso!");
    carregarTabela();
  });
});

// ===============================
// BUSCAR STATUS + TABELA (FIXA 24H)
// ===============================
function carregarTabela(){
  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {

      // carrega unidades salvas
      document.getElementById("unidade_1").value = data.unidade_1 ?? "";
      document.getElementById("unidade_2").value = data.unidade_2 ?? "";
      garantirSemDuplicar();

      // carrega conversão salva
      document.getElementById("conv_m_por_pcs").value = data.conv_m_por_pcs ?? 1;

      // ✅ preencher inputs de turno para não ficar vazio (e ajudar fallback)
      if(data.turno_inicio) document.getElementById("inicio").value = data.turno_inicio;
      if(data.turno_fim) document.getElementById("fim").value = data.turno_fim;
      if(data.meta_turno !== undefined && data.meta_turno !== null) document.getElementById("meta").value = data.meta_turno;
      if(data.rampa_percentual !== undefined && data.rampa_percentual !== null) document.getElementById("rampa").value = data.rampa_percentual;

      // ✅ início/fim do turno (nome correto vindo do backend)
      const inicioTurnoStr = (data.turno_inicio ?? document.getElementById("inicio").value);
      const fimTurnoStr = (data.turno_fim ?? document.getElementById("fim").value);

      // metas: vem indexado pelo turno -> remapeia pra 0..23
      const meta24 = mapTurnoListPara24h(data.meta_por_hora, inicioTurnoStr, 0);

      // produzido por hora: também vem indexado pelo turno -> remapeia
      const produzido24 = mapTurnoListPara24h(data.producao_por_hora, inicioTurnoStr, null);

      // regra A (não mostrar horas futuras) usando hora do dia
      const horaDiaAtual =
        (typeof data.ultima_hora === "number")
          ? (turnoIdxParaHoraDoDia(data.ultima_hora, inicioTurnoStr) ?? new Date().getHours())
          : new Date().getHours();

      // parcial da hora atual (backend) deve cair na hora do dia correspondente
      const produzidoHoraAtual = data.producao_hora ?? 0;

      const tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";

      for(let i = 0; i < 24; i++){
        const tr = document.createElement("tr");

        // destaque do turno ativo
        if(horaDentroDoTurno(i, inicioTurnoStr, fimTurnoStr)){
          tr.classList.add("turno-ativo");
        }

        const tdHora = document.createElement("td");
        tdHora.textContent = HORAS_FIXAS_24[i];

        const tdMeta = document.createElement("td");
        tdMeta.textContent = meta24[i] ?? 0;

        const tdProduzidoHora = document.createElement("td");
        const v = produzido24[i];

        // Regra A:
        // - hora futura => "—"
        // - não futura => usa persistido; se não tiver e for hora atual => parcial; senão "—"
        if (typeof horaDiaAtual === "number" && i > horaDiaAtual) {
          tdProduzidoHora.textContent = "—";
        } else if (v !== null && v !== undefined && v !== "") {
          tdProduzidoHora.textContent = v;
        } else if (i === horaDiaAtual) {
          tdProduzidoHora.textContent = produzidoHoraAtual;
        } else {
          tdProduzidoHora.textContent = "—";
        }

        const tdRefugoHora = document.createElement("td");
        tdRefugoHora.textContent = 0;

        tr.appendChild(tdHora);
        tr.appendChild(tdMeta);
        tr.appendChild(tdProduzidoHora);
        tr.appendChild(tdRefugoHora);

        tbody.appendChild(tr);
      }
    });
}

carregarTabela();
</script>

{% endblock %}
