{% extends "base.html" %}
{% block title %}Configuração da Máquina{% endblock %}

{% block content %}

<div class="container">

  <h1 class="section-title" id="titulo-maquina">Configuração da Máquina</h1>

  <div class="card">

    <form id="config-form">

      <!-- META DO TURNO -->
      <label>Meta do Turno (pcs):</label>
      <input type="number" id="meta" required>

      <!-- HORÁRIOS -->
      <div class="row mt-20">
        <div class="col">
          <label>Início do Turno:</label>
          <input type="time" id="inicio" required>
        </div>

        <div class="col">
          <label>Fim do Turno:</label>
          <input type="time" id="fim" required>
        </div>
      </div>

      <!-- RAMPA -->
      <label class="mt-20">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <button class="btn btn-primary mt-20" type="submit">Salvar Configuração</button>
    </form>

  </div>

  <!-- TABELA GERADA AUTOMATICAMENTE -->
  <h2 class="section-title mt-30">Distribuição da Meta por Hora</h2>

  <div class="card">
    <table class="table" id="tabela-horas">
      <thead>
        <tr>
          <th>Faixa Horária</th>
          <th>Meta da Hora</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>


<script>
// ===========================================
// CAPTURA machine_id DA URL
// ===========================================
const machine_id = window.location.pathname.split("/").pop();
console.log("Configuração da:", machine_id);

// Atualiza título
document.getElementById("titulo-maquina").textContent =
  "Configuração da Máquina — " + machine_id.toUpperCase();


// ===========================================
// SUBMIT DO FORMULÁRIO
// ===========================================
document.getElementById("config-form").addEventListener("submit", function(e){
  e.preventDefault();

  const meta = document.getElementById("meta").value;
  const inicio = document.getElementById("inicio").value;
  const fim = document.getElementById("fim").value;
  const rampa = document.getElementById("rampa").value;

  fetch("/machine/config", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      machine_id: machine_id,
      meta_turno: meta,
      inicio: inicio,
      fim: fim,
      rampa: rampa
    })
  })
  .then(r => r.json())
  .then(resp => {
    alert("Configuração salva com sucesso!");
    carregarTabela();
  });
});


// ===========================================
// BUSCAR TABELA DO BACKEND
// ===========================================
function carregarTabela(){

  fetch(`/machine/status?machine_id=${machine_id}`)
    .then(r => r.json())
    .then(data => {

      const horas = data.horas_turno || [];
      const metas = data.meta_por_hora || [];

      let tbody = document.querySelector("#tabela-horas tbody");
      tbody.innerHTML = "";

      for(let i = 0; i < horas.length; i++){
        let tr = document.createElement("tr");

        let tdHora = document.createElement("td");
        tdHora.textContent = horas[i];

        let tdMeta = document.createElement("td");
        tdMeta.textContent = metas[i];

        tr.appendChild(tdHora);
        tr.appendChild(tdMeta);

        tbody.appendChild(tr);
      }
    });
}

// Carrega ao abrir a página
carregarTabela();
</script>

{% endblock %}
