{% extends "base.html" %}
{% block title %}Dispositivos — IndFlow{% endblock %}

{% block content %}
<div class="page">

  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
    <h1>Dispositivos (ESP / PLC)</h1>
    <div style="display:flex; gap:10px; align-items:center;">
      <form method="post" action="/devices/cleanup-invalid" style="margin:0;">
        <button class="btn btn-secondary" type="submit" title="Remove registros que não são MAC válido (12 hex)">
          Limpar inválidos
        </button>
      </form>
      <a href="/producao" class="btn btn-secondary">Voltar</a>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3 style="margin:0 0 8px 0;">Cadastro e vínculo</h3>
    <p style="margin:0; color:#475569;">
      Aqui você gerencia o vínculo entre <b>Device (MAC)</b> e <b>Máquina (machine_id)</b>.
      O MAC é o “CPF” do dispositivo. A máquina é o card/ativo no sistema.
    </p>
  </div>

  <!-- LISTA DE DEVICES -->
  <div class="card" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">Devices detectados</h3>

    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding:10px 12px;">MAC (device_id)</th>
          <th style="text-align:left; padding:10px 12px;">Alias</th>
          <th style="text-align:left; padding:10px 12px;">Vinculado à máquina</th>
          <th style="text-align:left; padding:10px 12px;">Último contato</th>
          <th style="text-align:left; padding:10px 12px;">Status</th>
          <th style="text-align:left; padding:10px 12px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% if devices and devices|length > 0 %}
          {% for d in devices %}
            <tr>
              <td style="padding:10px 12px; font-family:monospace;">
                {{ d.device_id }}
                {% if d.is_valid_mac is defined and not d.is_valid_mac %}
                  <span class="badge" style="margin-left:8px; background:#f59e0b; color:#111827; padding:4px 8px; border-radius:10px;">
                    INVÁLIDO
                  </span>
                {% endif %}
              </td>

              <!-- ALIAS -->
              <td style="padding:10px 12px;">
                {% if d.is_valid_mac is defined and d.is_valid_mac %}
                  <form method="post" action="/devices/alias" style="display:flex; gap:8px; align-items:center; margin:0;">
                    <input type="hidden" name="device_id" value="{{ d.device_id }}">
                    <input
                      name="alias"
                      class="input"
                      placeholder="Ex: ESP Linha 1"
                      value="{{ d.alias if d.alias else '' }}"
                      style="width:180px;"
                    >
                    <button class="btn btn-primary" type="submit" title="Salvar alias">Salvar</button>
                  </form>
                {% else %}
                  <span style="color:#94a3b8;">—</span>
                {% endif %}
              </td>

              <td style="padding:10px 12px;">{{ d.machine_id if d.machine_id else "—" }}</td>
              <td style="padding:10px 12px;">{{ d.last_seen if d.last_seen else "—" }}</td>

              <!-- STATUS -->
              <td style="padding:10px 12px;">
                {% if d.machine_id %}
                  <span class="badge" style="background:#16a34a; color:#fff; padding:4px 8px; border-radius:10px;">VINCULADO</span>
                {% else %}
                  <span class="badge" style="background:#dc2626; color:#fff; padding:4px 8px; border-radius:10px;">NÃO VINCULADO</span>
                {% endif %}
              </td>

              <!-- AÇÕES -->
              <td style="padding:10px 12px;">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  {% if d.is_valid_mac is defined and d.is_valid_mac %}
                    <form method="post" action="/devices/unlink" style="margin:0;">
                      <input type="hidden" name="device_id" value="{{ d.device_id }}">
                      <button class="btn btn-secondary" type="submit" title="Remove o vínculo com a máquina">
                        Desvincular
                      </button>
                    </form>
                  {% endif %}

                  <form method="post" action="/devices/delete" style="margin:0;">
                    <input type="hidden" name="device_id" value="{{ d.device_id }}">
                    <button class="btn btn-secondary" type="submit" title="Remove o device da lista">
                      Excluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" style="padding:12px; color:#64748b;">
              Nenhum device listado ainda. Assim que o ESP enviar dados (com MAC), ele deve aparecer aqui.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- VINCULAR DEVICE -->
  <div class="card" style="margin-top:14px;">
    <h3 style="margin:0 0 10px 0;">Vincular device (MAC) a uma máquina</h3>

    <form method="post" action="/devices/link" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      <div style="min-width:260px;">
        <label style="display:block; margin-bottom:6px;">MAC (device_id)</label>
        <input
          name="device_id"
          class="input"
          placeholder="Ex: A4CF12B3D91E"
          style="width:260px; font-family:monospace;"
          required
        >
      </div>

      <div style="min-width:260px;">
        <label style="display:block; margin-bottom:6px;">Máquina (machine_id)</label>
        <input
          name="machine_id"
          class="input"
          placeholder="Ex: maquina01 ou maquina01_dev"
          style="width:260px;"
          required
        >
      </div>

      <button class="btn btn-primary" type="submit">
        Salvar vínculo
      </button>
    </form>

    <p style="margin:10px 0 0 0; color:#64748b;">
      Dica: use <b>maquina01_dev</b> para testes e <b>maquina01</b> para produção. O mesmo MAC pode ser re-vinculado depois.
    </p>
  </div>

</div>
{% endblock %}
