<!--
Caminho: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\templates\utilidades_home.html
Último recode: 2026-01-17 08:25 (America/Bahia)
Motivo: Transformar tela de Utilidades em cards de SISTEMAS (Ar Comprimido, Energia/Gerador) com pré-configuração e resumo; mantém uso dos sinais digitais atuais (compressor/gerador) e integra status do sistema via /utilidades/system/status quando disponível.
-->

{% extends "base.html" %}
{% block title %}Utilidades — IndFlow{% endblock %}

{% block content %}

<style>
  .page { padding: 24px; }

  .machine-grid{
    display:flex;
    flex-wrap:wrap;
    gap:24px;
    margin-top:20px;
  }

  .card-link{
    text-decoration:none;
    color:inherit;
  }

  .card{
    background:#fff;
    width: 520px;
    border-radius:20px;
    padding:28px;
    box-shadow:0 4px 14px rgba(0,0,0,0.12);
    border:1px solid #e5e7eb;
    transition:0.2s;
    position: relative;
  }

  .card:hover{
    transform:translateY(-3px);
    box-shadow:0 6px 20px rgba(0,0,0,0.20);
  }

  .card-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 10px;
  }

  .card-title{
    font-size:24px;
    font-weight:800;
    color:#0f172a;
  }

  .badge{
    display:inline-block;
    padding:6px 12px;
    border-radius:8px;
    font-size:13px;
    font-weight:900;
    color:#fff;
    min-width: 120px;
    text-align:center;
  }

  .badge-ok{ background:#16a34a; }
  .badge-warn{ background:#f59e0b; }
  .badge-stop{ background:#dc2626; }
  .badge-unk{ background:#6b7280; }

  .subline{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top: 10px;
    font-size:16px;
    color:#0f172a;
  }

  .k{ color:#334155; font-weight:700; }
  .v{ font-weight:900; color:#0f172a; }

  .muted{ color:#64748b; font-weight:700; }

  .stopline{
    margin-top: 8px;
    font-size:14px;
    font-weight:900;
    color:#dc2626;
    display:none;
  }

  .footer-note{
    margin-top: 14px;
    font-size: 13px;
    font-weight: 800;
    color:#64748b;
    text-align:right;
  }
</style>

<div class="page">
  <h1 class="section-title">Utilidades</h1>
  <div id="utilidades-grid" class="machine-grid"></div>
</div>

<script>
/**
 * CONCEITO (V1):
 * - Tela mostra SISTEMAS (cards PAI), pré-configurados.
 * - Clique abre a configuração do primeiro equipamento do sistema (por enquanto),
 *   até criarmos a página de detalhes do sistema.
 *
 * Backend novo (quando existir/ativo):
 * - GET /utilidades/system/status?system_id=<id>
 *   retorna status, pressure_ok, power_kw, energy_kwh_day, parado_min, etc.
 *
 * Legado (já existe e você usa hoje):
 * - GET /utilidades/status?machine_id=util_comp01 / util_ger01
 *   retorna ligado/falha/horas_vida.
 */

// ✅ Cards PAI pré-configurados (sistemas)
const sistemas = [
  {
    system_id: "air_01",
    nome: "Ar Comprimido",
    // por enquanto, clique vai para o primeiro equipamento do sistema:
    config_target: "util_comp01",
    // equipamentos do legado que representam esse sistema (V1)
    legacy_equip_ids: ["util_comp01"],
    // busca status do sistema (novo backend)
    use_system_api: true
  },
  {
    system_id: "gen_01",
    nome: "Energia / Gerador",
    config_target: "util_ger01",
    legacy_equip_ids: ["util_ger01"],
    // ainda pode não existir no system_api; mantemos via legado
    use_system_api: false
  },
];

// Helpers
function fmtNum(v, digits=2){
  const n = Number(v);
  if(!Number.isFinite(n)) return "—";
  const fixed = n.toFixed(digits);
  return fixed.replace(".", ",");
}

function fmtInt(v){
  const n = Number(v);
  if(!Number.isFinite(n)) return "—";
  return String(Math.floor(n));
}

function badgeClass(status){
  const s = String(status || "").toUpperCase();
  if(s === "PRODUZINDO") return "badge-ok";
  if(s === "ATENCAO" || s === "ATENÇÃO") return "badge-warn";
  if(s === "PARADA") return "badge-stop";
  return "badge-unk";
}

function normalizeStatus(status){
  const s = String(status || "").toUpperCase().trim();
  if(s === "ATENÇÃO") return "ATENCAO";
  if(["PRODUZINDO","ATENCAO","PARADA","DESCONHECIDO"].includes(s)) return s;
  return "DESCONHECIDO";
}

function pressureText(pressure_ok){
  if(pressure_ok === true) return "OK";
  if(pressure_ok === false) return "BAIXA";
  return "—";
}

// ===============================
// CRIA OS CARDS UMA ÚNICA VEZ
// ===============================
function criarCards(){
  const area = document.getElementById("utilidades-grid");
  area.innerHTML = "";

  sistemas.forEach(sys => {
    const a = document.createElement("a");
    a.className = "card-link";
    a.href = `/utilidades/config/${sys.config_target}`;

    a.innerHTML = `
      <div class="card" id="card-${sys.system_id}">
        <div class="card-head">
          <div class="card-title">${sys.nome}</div>
          <div id="badge-${sys.system_id}" class="badge badge-unk">DESCONHECIDO</div>
        </div>

        <div id="stop-${sys.system_id}" class="stopline">0 min parados</div>

        <div class="subline">
          <div class="k">Pressão</div>
          <div class="v" id="pressure-${sys.system_id}">—</div>
        </div>

        <div class="subline">
          <div class="k">Equipamentos ativos</div>
          <div class="v" id="equip-${sys.system_id}">—</div>
        </div>

        <div class="subline">
          <div class="k">Potência agora</div>
          <div class="v" id="power-${sys.system_id}">—</div>
        </div>

        <div class="subline">
          <div class="k">Consumo hoje</div>
          <div class="v" id="energy-${sys.system_id}">—</div>
        </div>

        <div class="footer-note">Clique para detalhes</div>
      </div>
    `;

    area.appendChild(a);
  });
}

// ===============================
// 1) BUSCA LEGADO (equipamentos)
// ===============================
async function fetchLegacyEquip(machine_id){
  const r = await fetch(`/utilidades/status?machine_id=${machine_id}`);
  if(!r.ok) return null;
  return await r.json();
}

async function calcLegacyEquipSummary(legacy_ids){
  // soma simples: considera "ativo" se ligado==1 e falha==0
  let total = 0;
  let ativos = 0;

  for(const id of legacy_ids){
    const d = await fetchLegacyEquip(id);
    if(!d) continue;
    total++;
    const ligado = Number(d.ligado) === 1;
    const falha = Number(d.falha) === 1;
    if(ligado && !falha) ativos++;
  }

  if(total === 0) return null;
  return { total, ativos };
}

// ===============================
// 2) BUSCA SYSTEM API (novo)
// ===============================
async function fetchSystemStatus(system_id){
  const r = await fetch(`/utilidades/system/status?system_id=${system_id}`);
  if(!r.ok) return null;
  return await r.json();
}

// ===============================
// ATUALIZA SOMENTE OS VALORES
// ===============================
async function atualizarSistemas(){
  for(const sys of sistemas){
    // DOM refs
    const badgeEl = document.getElementById(`badge-${sys.system_id}`);
    const stopEl = document.getElementById(`stop-${sys.system_id}`);
    const pressureEl = document.getElementById(`pressure-${sys.system_id}`);
    const equipEl = document.getElementById(`equip-${sys.system_id}`);
    const powerEl = document.getElementById(`power-${sys.system_id}`);
    const energyEl = document.getElementById(`energy-${sys.system_id}`);

    // defaults
    let status = "DESCONHECIDO";
    let pressure_ok = null;
    let power_kw = null;
    let energy_kwh_day = null;
    let parado_min = null;

    // (A) resumo de equipamentos via legado (sempre)
    const eqSum = await calcLegacyEquipSummary(sys.legacy_equip_ids);
    if(eqSum){
      equipEl.textContent = `${eqSum.ativos}/${eqSum.total}`;
    }else{
      equipEl.textContent = "—";
    }

    // (B) se tiver system api ativo, usa para pressão/energia/status/parada
    if(sys.use_system_api){
      const s = await fetchSystemStatus(sys.system_id);
      if(s){
        status = normalizeStatus(s.status);
        pressure_ok = (s.pressure_ok === true || s.pressure_ok === false) ? s.pressure_ok : null;
        power_kw = s.power_kw;
        energy_kwh_day = s.energy_kwh_day;
        parado_min = s.parado_min;
      }else{
        // fallback: sem system api ainda -> inferência básica por legado
        if(eqSum && eqSum.ativos >= 1){
          status = "PRODUZINDO";
        }else if(eqSum){
          status = "PARADA";
        }
      }
    }else{
      // (C) sistema sem system api ainda -> status por legado
      if(eqSum && eqSum.ativos >= 1){
        status = "PRODUZINDO";
      }else if(eqSum){
        status = "PARADA";
      }
    }

    // Atualiza badge
    badgeEl.textContent = status;
    badgeEl.className = `badge ${badgeClass(status)}`;

    // Pressão
    // Só exibe pressão (OK/BAIXA) no Ar Comprimido (system_api)
    pressureEl.textContent = (sys.use_system_api ? pressureText(pressure_ok) : "—");

    // Consumo (quando existir)
    powerEl.textContent = (power_kw === null || power_kw === undefined) ? "—" : `${fmtNum(power_kw, 1)} kW`;
    energyEl.textContent = (energy_kwh_day === null || energy_kwh_day === undefined) ? "—" : `${fmtNum(energy_kwh_day, 1)} kWh`;

    // Linha de parada
    if(status === "PARADA" && parado_min !== null && parado_min !== undefined){
      stopEl.textContent = `${fmtInt(parado_min)} min parados`;
      stopEl.style.display = "";
    }else{
      stopEl.textContent = "";
      stopEl.style.display = "none";
    }
  }
}

// INIT
criarCards();
atualizarSistemas();
setInterval(atualizarSistemas, 2000);
</script>

{% endblock %}
