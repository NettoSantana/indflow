<!--
PATH: C:\Users\vlula\OneDrive\Ãrea de Trabalho\Projetos Backup\indflow\modules\producao\templates\config_maquina_for.html
LAST_RECODE: 2026-02-26 13:46 (America/Bahia)
MOTIVO: Corrigir acessibilidade (labels associados a campos) para remover avisos no DevTools/Lighthouse.
-->
{% extends "base.html" %}

{% block title %}Configuracao da Maquina{% endblock %}

{% block content %}
<style>
#tabela-horas tbody tr:nth-child(even){background-color:#f3f4f6;} #tabela-horas tbody tr:nth-child(odd){background-color:#ffffff;} #tabela-horas tbody tr:hover{background-color:#e5e7eb;}
#tabela-horas tbody tr.turno-ativo{background-color:#e0f2fe;background-image:linear-gradient(180deg,#ffffff 0%,#e0f2fe 100%);border-top:1px solid #ffffff;border-bottom:1px solid #bfdbfe;}
#tabela-horas tbody tr.turno-ativo:hover{background-color:#bae6fd;background-image:linear-gradient(180deg,#f0f9ff 0%,#bae6fd 100%);}
#tabela-horas tbody tr.pausa-planejada{background-color:#f1f5f9;background-image:linear-gradient(180deg,#ffffff 0%,#f1f5f9 100%);border-top:1px solid #ffffff;border-bottom:1px solid #e2e8f0;}
#tabela-horas tbody tr.pausa-planejada:hover{background-color:#e2e8f0;background-image:linear-gradient(180deg,#ffffff 0%,#e2e8f0 100%);}
.refugo-input{width:90px;padding:6px 8px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;text-align:center;background:#ffffff;}
.refugo-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,0.20);}
.refugo-input:disabled{background:#e5e7eb;color:#64748b;cursor:not-allowed;}
.help-text{font-size:13px;color:#64748b;margin-top:6px;line-height:1.3;}
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:flex;align-items:center;justify-content:center;padding:18px;z-index:50;}
.modal{width:100%;max-width:640px;background:#fff;border-radius:18px;border:1px solid #e5e7eb;box-shadow:0 18px 40px rgba(0,0,0,0.18);overflow:hidden;}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #e5e7eb;background:#f8fafc;}
.modal-title{font-size:14px;font-weight:900;color:#0f172a;}
.modal-close{border:1px solid #e5e7eb;background:#fff;border-radius:10px;width:34px;height:34px;font-size:16px;line-height:32px;text-align:center;cursor:pointer;}
.modal-body{padding:16px;max-height:80vh;overflow-y:auto;}
.shift-card{border:1px solid #e5e7eb;border-radius:14px;padding:12px 12px;background:#ffffff;}
.shift-head{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.shift-title{font-size:13px;font-weight:900;color:#0f172a;text-transform:uppercase;letter-spacing:0.03em;}
.shift-actions{display:flex;gap:8px;flex-wrap:wrap;}
.break-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.break-row .input{min-width:140px;}
.summary-table td,.summary-table th{padding:8px 10px;border-bottom:1px solid #e5e7eb;font-size:13px;}
.summary-table th{text-align:left;color:#334155;font-weight:900;}
.days-box{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}
.day-pill{display:flex;align-items:center;gap:6px;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;background:#f8fafc;font-size:13px;color:#0f172a;}
</style>

<div>
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
    <h1 class="section-title" id="titulo-maquina">Configuracao da Maquina</h1>
    <button id="btn-reset" type="button" class="btn" style="background:#dc2626;color:#fff;">Zerar Producao</button>
  </div>

  <div class="card">
    <form id="config-form">
      <div class="mt-20" id="sec-dias-ativos">Dias ativos da maquina:</div>
      <div class="days-box" id="dias-ativos"></div>
      <div class="help-text">Usado para planejamento. Por enquanto, nao bloqueia a contagem automaticamente.</div>

      <div class="mt-20" id="sec-turnos">Turnos (ate 3) com pausas planejadas (almoco, cafe, setup):</div>
      <div id="shifts-container" style="display:flex;flex-direction:column;gap:12px;margin-top:10px;"></div>
      <div style="display:flex;justify-content:flex-start;gap:10px;margin-top:10px;flex-wrap:wrap;">
        <button id="btnAddShift" type="button" class="btn btn-secondary">Adicionar turno</button>
      </div>

      <div class="mt-20" id="shifts-summary-wrap" style="display:none;">
        <div id="sec-resumo" style="font-weight:900;color:#0f172a;">Resumo (tempo planejado e metas):</div>
        <div class="card" style="margin-top:10px;padding:0;">
          <table class="summary-table" style="width:100%;border-collapse:collapse;">
            <thead>
              <tr>
                <th>Turno</th><th>Duracao</th><th>Pausas</th><th>Planejado</th><th>Meta</th><th>Meta/h</th>
              </tr>
            </thead>
            <tbody id="shifts-summary-body"></tbody>
            <tfoot>
              <tr>
                <th>Total</th><th id="sum-dur">-</th><th id="sum-break">-</th><th id="sum-plan">-</th><th id="sum-meta">-</th><th id="sum-metah">-</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <label class="mt-20" for="ideal_sec_per_piece">Tempo ideal por peca (segundos):</label>
      <input type="number" id="ideal_sec_per_piece" class="input" step="0.01" min="0.01" placeholder="Ex: 3.20" required>
      <div class="help-text">Necessario para Performance e OEE real.</div>

      <label class="mt-20" for="rampa">Rampa Inicial (%):</label>
      <input type="number" id="rampa" min="0" max="100" required>

      <label class="mt-20" for="no_count_stop_sec">Alerta de Parada por Inatividade (segundos sem producao):</label>
      <input type="number" id="no_count_stop_sec" class="input" min="5" step="1" placeholder="Ex: 60" required>
      <div class="help-text">Mesmo que a maquina esteja em AUTO/PRODUZINDO, se nao houver aumento de contagem por este tempo, o sistema considera PARADA.</div>

      <div class="mt-20" id="sec-unidades">Unidade de Producao (ate 2):</div>
      <div class="row">
        <div class="col">
          <label for="unidade_1" style="display:block;margin-bottom:6px;">Unidade 1:</label>
          <select id="unidade_1" class="input">
            <option value="">-</option><option value="pcs">Unidade (pcs)</option><option value="m">Metro linear (m)</option><option value="m2">Metro quadrado (m2)</option>
          </select>
        </div>
        <div class="col">
          <label for="unidade_2" style="display:block;margin-bottom:6px;">Unidade 2:</label>
          <select id="unidade_2" class="input">
            <option value="">-</option><option value="pcs">Unidade (pcs)</option><option value="m">Metro linear (m)</option><option value="m2">Metro quadrado (m2)</option>
          </select>
        </div>
      </div>

      <label class="mt-20" for="conv_m_por_pcs">Conversao (1 pcs = X metros) (use quando houver pcs e metros):</label>
      <input type="number" id="conv_m_por_pcs" class="input" step="0.001" min="0.001" placeholder="Ex: 0.85">

      <button class="btn btn-primary mt-20" type="submit">Salvar Configuracao</button>
    </form>
  </div>

  <div class="modal-backdrop" id="opModalBackdrop" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="opModalTitle">Nova Ordem de Producao (OP)</div>
        <button class="modal-close" id="btnCloseOpModal" type="button" aria-label="Fechar">x</button>
      </div>
      <div class="modal-body">
        <form id="op-form">
          <label for="op_os">OS:</label><input type="text" id="op_os" class="input" required>
          <label class="mt-20" for="op_lote">Lote:</label><input type="text" id="op_lote" class="input" required>
          <label class="mt-20" for="op_operador">Operador:</label><input type="text" id="op_operador" class="input" required>
          <div class="mt-20" id="sec-bobinas" style="font-weight:900;color:#0f172a;">Bobinas (opcional):</div>
          <div class="help-text">Adicione uma ou mais bobinas em metros (somente numeros). Se ficar vazio, nenhuma bobina sera registrada.</div>
          <div id="op_bobinas_list" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;"></div>
          <button id="btnAddBobina" type="button" class="btn btn-secondary" style="margin-top:10px;">Adicionar bobina</button>
          <input type="hidden" id="op_bobina" value="">
          <label class="mt-20" for="op_gr_fio">GR / Fio (opcional):</label><input type="text" id="op_gr_fio" class="input">
          <label class="mt-20" for="op_obs">Observacoes (opcional):</label><textarea id="op_obs" class="input" rows="3" style="resize:vertical;"></textarea>
          <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:18px;">
            <button type="button" class="btn btn-secondary" id="btnCancelOp">Cancelar</button>
            <button type="submit" class="btn btn-primary" id="btnStartOp">Iniciar OP</button>
          </div>
        </form>
        <div class="help-text" style="margin-top:10px;">Inicio e fim da OP sao automaticos (ao iniciar e encerrar).</div>
      </div>
    </div>
  </div>

  <h2 class="section-title mt-30">Distribuicao da Meta por Hora (24h)</h2>
  <div class="card">
    <table class="table" id="tabela-horas">
      <thead><tr><th>Faixa Horaria</th><th>Meta da Hora</th><th>Produzido Hora</th><th>Refugo Hora</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const machine_id = window.location.pathname.split("/").pop();
document.getElementById("titulo-maquina").textContent = "Configuracao da Maquina - " + String(machine_id||"").toUpperCase();

function pad2(n){ return String(n).padStart(2,"0"); }
function buildFaixas24(){ const out=[]; for(let h=0; h<24; h++){ const h2=(h+1)%24; out.push(`${pad2(h)}:00-${pad2(h2)}:00`); } return out; }
const HORAS_FIXAS_24 = buildFaixas24();

function parseMinFromTimeStr(s){ if(!s||typeof s!=="string")return null; const p=s.split(":"); const h=Number(p[0]); const m=Number(p[1]??0);
  if(!Number.isFinite(h)||h<0||h>23)return null; if(!Number.isFinite(m)||m<0||m>59)return null; return h*60+m; }
function minToHHMM(min){ const m=((min%1440)+1440)%1440; const h=Math.floor(m/60); const mm=m%60; return `${pad2(h)}:${pad2(mm)}`; }

function normalizeRange(startMin,endMin){ startMin=((startMin%1440)+1440)%1440; endMin=((endMin%1440)+1440)%1440;
  if(startMin===endMin) return []; if(startMin<endMin) return [[startMin,endMin]]; return [[startMin,1440],[0,endMin]]; }
function overlap(a0,a1,b0,b1){ return Math.max(a0,b0) < Math.min(a1,b1); }
function intervalPlannedMinutesInHour(hourMin0,hourMin1,shiftRanges,breakRanges){ let planned=0;
  // planned = overlap with shift - overlap with breaks
  for(const sr of shiftRanges){ const s0=sr[0], s1=sr[1]; if(!overlap(hourMin0,hourMin1,s0,s1)) continue; const inShift0=Math.max(hourMin0,s0); const inShift1=Math.min(hourMin1,s1); let seg=inShift1-inShift0;
    for(const br of breakRanges){ const b0=br[0], b1=br[1]; if(!overlap(inShift0,inShift1,b0,b1)) continue; const cut0=Math.max(inShift0,b0); const cut1=Math.min(inShift1,b1); seg -= Math.max(0,cut1-cut0); }
    planned += Math.max(0,seg);
  }
  return planned;
}

function ensureArray(x){ return Array.isArray(x) ? x : []; }

// Days UI
const DAYS = [
  {key:1,label:"Seg"},{key:2,label:"Ter"},{key:3,label:"Qua"},{key:4,label:"Qui"},{key:5,label:"Sex"},{key:6,label:"Sab"},{key:0,label:"Dom"}
];
function renderDays(activeSet){
  const box=document.getElementById("dias-ativos");
  box.innerHTML="";
  for(const d of DAYS){
    const wrap=document.createElement("label");
    wrap.className="day-pill";
    const cb=document.createElement("input");
    cb.type="checkbox"; cb.dataset.day=String(d.key);
    cb.checked = activeSet ? activeSet.has(d.key) : true;
    wrap.appendChild(cb);
    const span=document.createElement("span");
    span.textContent=d.label;
    wrap.appendChild(span);
    box.appendChild(wrap);
  }
}
function getActiveDays(){
  const box=document.getElementById("dias-ativos");
  const cbs=box.querySelectorAll("input[type=checkbox]");
  const out=[];
  cbs.forEach(cb=>{ if(cb.checked) out.push(Number(cb.dataset.day)); });
  return out;
}

// Shifts UI state
let shiftsState = [];
let lastStatusCache = null;
let configDirty = false;

function markConfigDirty(){ configDirty = true; }
function clearConfigDirty(){ configDirty = false; }


function shiftDefaultName(idx){ return String.fromCharCode(65+idx); } // A,B,C
function newShiftSkeleton(idx){
  return {
    name: shiftDefaultName(idx),
    start: "06:00",
    end: "14:00",
    meta_pcs: 0,
    breaks: [{name:"Almoco", start:"12:00", end:"13:00"}]
  };
}
function newBreakSkeleton(){ return {name:"Almoco", start:"12:00", end:"13:00"}; }

function renderShifts(){
  const container=document.getElementById("shifts-container");
  container.innerHTML="";
  shiftsState = ensureArray(shiftsState);

  shiftsState.forEach((s, idx)=>{
    const card=document.createElement("div");
    card.className="shift-card";

    const head=document.createElement("div");
    head.className="shift-head";

    const title=document.createElement("div");
    title.className="shift-title";
    title.textContent = "Turno " + (s.name || shiftDefaultName(idx));

    const actions=document.createElement("div");
    actions.className="shift-actions";

    const btnRemove=document.createElement("button");
    btnRemove.type="button";
    btnRemove.className="btn btn-secondary";
    btnRemove.textContent="Remover turno";
    btnRemove.addEventListener("click",()=>{ markConfigDirty(); 
      shiftsState.splice(idx,1);
      // reindex names if empty
      shiftsState.forEach((sh,i)=>{ if(!sh.name) sh.name = shiftDefaultName(i); });
      renderShifts(); renderSummary(); atualizarTabelaLocal();
    });

    actions.appendChild(btnRemove);
    head.appendChild(title);
    head.appendChild(actions);
    card.appendChild(head);

    const grid=document.createElement("div");
    grid.className="row";
    grid.style.marginTop="10px";

    const col1=document.createElement("div"); col1.className="col";
    const col2=document.createElement("div"); col2.className="col";
    const col3=document.createElement("div"); col3.className="col";

    const lblName=document.createElement("label"); lblName.textContent="Nome do turno:";
    const inpName=document.createElement("input"); inpName.type="text"; inpName.className="input"; inpName.value=String(s.name||"");
    inpName.id = `shift_${idx}_name`;
    lblName.htmlFor = inpName.id;
    inpName.addEventListener("input",()=>{ markConfigDirty();  s.name = String(inpName.value||"").trim(); title.textContent = "Turno " + (s.name || shiftDefaultName(idx)); renderSummary(); atualizarTabelaLocal(); });
    col1.appendChild(lblName); col1.appendChild(inpName);

    const lblStart=document.createElement("label"); lblStart.textContent="Inicio:";
    const inpStart=document.createElement("input"); inpStart.type="time"; inpStart.className="input"; inpStart.value=String(s.start||"");
    inpStart.id = `shift_${idx}_start`;
    lblStart.htmlFor = inpStart.id;
    inpStart.addEventListener("change",()=>{ markConfigDirty();  s.start = String(inpStart.value||""); renderSummary(); atualizarTabelaLocal(); });
    col2.appendChild(lblStart); col2.appendChild(inpStart);

    const lblEnd=document.createElement("label"); lblEnd.textContent="Fim:";
    const inpEnd=document.createElement("input"); inpEnd.type="time"; inpEnd.className="input"; inpEnd.value=String(s.end||"");
    inpEnd.id = `shift_${idx}_end`;
    lblEnd.htmlFor = inpEnd.id;
    inpEnd.addEventListener("change",()=>{ markConfigDirty();  s.end = String(inpEnd.value||""); renderSummary(); atualizarTabelaLocal(); });
    col3.appendChild(lblEnd); col3.appendChild(inpEnd);

    grid.appendChild(col1); grid.appendChild(col2); grid.appendChild(col3);
    card.appendChild(grid);

    const grid2=document.createElement("div");
    grid2.className="row";
    grid2.style.marginTop="10px";
    const cmeta=document.createElement("div"); cmeta.className="col";
    const lmeta=document.createElement("label"); lmeta.textContent="Meta do turno (pcs):";
    const imeta=document.createElement("input"); imeta.type="number"; imeta.className="input"; imeta.min="0"; imeta.step="1"; imeta.value=String(s.meta_pcs ?? 0);
    imeta.id = `shift_${idx}_meta`;
    lmeta.htmlFor = imeta.id;
    imeta.addEventListener("input",()=>{ markConfigDirty();  const v=Number(imeta.value); s.meta_pcs = (Number.isFinite(v) && v>=0) ? Math.floor(v) : 0; renderSummary(); atualizarTabelaLocal(); });
    cmeta.appendChild(lmeta); cmeta.appendChild(imeta);
    const cspacer=document.createElement("div"); cspacer.className="col";
    grid2.appendChild(cmeta); grid2.appendChild(cspacer);
    card.appendChild(grid2);

    const breaksWrap=document.createElement("div");
    breaksWrap.style.marginTop="12px";
    const bl=document.createElement("label"); bl.textContent="Pausas planejadas:";
    breaksWrap.appendChild(bl);

    const list=document.createElement("div");
    list.style.display="flex"; list.style.flexDirection="column"; list.style.gap="10px"; list.style.marginTop="8px";

    const brks=ensureArray(s.breaks);
    if(brks.length===0) brks.push(newBreakSkeleton());
    s.breaks = brks;

    brks.forEach((b, bidx)=>{
      const row=document.createElement("div");
      row.className="break-row";

      const inName=document.createElement("input");
      inName.type="text"; inName.className="input"; inName.placeholder="Nome"; inName.value=String(b.name||"");
      inName.setAttribute("aria-label","Nome da pausa");
      inName.addEventListener("input",()=>{ markConfigDirty();  b.name=String(inName.value||"").trim(); renderSummary(); atualizarTabelaLocal(); });

      const inStart=document.createElement("input");
      inStart.type="time"; inStart.className="input"; inStart.value=String(b.start||"");
      inStart.setAttribute("aria-label","Inicio da pausa");
      inStart.addEventListener("change",()=>{ markConfigDirty();  b.start=String(inStart.value||""); renderSummary(); atualizarTabelaLocal(); });

      const inEnd=document.createElement("input");
      inEnd.type="time"; inEnd.className="input"; inEnd.value=String(b.end||"");
      inEnd.setAttribute("aria-label","Fim da pausa");
      inEnd.addEventListener("change",()=>{ markConfigDirty();  b.end=String(inEnd.value||""); renderSummary(); atualizarTabelaLocal(); });

      const btnR=document.createElement("button");
      btnR.type="button"; btnR.className="btn btn-secondary"; btnR.textContent="Remover pausa";
      btnR.addEventListener("click",()=>{ markConfigDirty(); 
        s.breaks.splice(bidx,1);
        renderShifts(); renderSummary(); atualizarTabelaLocal();
      });

      row.appendChild(inName); row.appendChild(inStart); row.appendChild(inEnd); row.appendChild(btnR);
      list.appendChild(row);
    });

    breaksWrap.appendChild(list);

    const btnAddBreak=document.createElement("button");
    btnAddBreak.type="button";
    btnAddBreak.className="btn btn-secondary";
    btnAddBreak.textContent="Adicionar pausa";
    btnAddBreak.style.marginTop="10px";
    btnAddBreak.addEventListener("click",()=>{ markConfigDirty(); 
      s.breaks.push(newBreakSkeleton());
      renderShifts(); renderSummary(); atualizarTabelaLocal();
    });

    breaksWrap.appendChild(btnAddBreak);
    card.appendChild(breaksWrap);

    container.appendChild(card);
  });

  const btnAddShift=document.getElementById("btnAddShift");
  if(btnAddShift) btnAddShift.disabled = shiftsState.length >= 3;
}

function shiftsToRanges(sh){ 
  const sm=parseMinFromTimeStr(sh.start); const em=parseMinFromTimeStr(sh.end);
  if(sm===null || em===null) return {shiftRanges:[], breakRanges:[], dur:0, breakMin:0, plan:0};
  const shiftRanges=normalizeRange(sm,em);
  let dur=0; shiftRanges.forEach(r=>{ dur += (r[1]-r[0]); });
  const breakRanges=[];
  let breakMin=0;
  for(const b of ensureArray(sh.breaks)){
    const bm=parseMinFromTimeStr(b.start); const be=parseMinFromTimeStr(b.end);
    if(bm===null || be===null) continue;
    const br=normalizeRange(bm,be);
    br.forEach(r=>breakRanges.push(r));
    br.forEach(r=>{ breakMin += (r[1]-r[0]); });
  }
  const plan=Math.max(0,dur-breakMin);
  return {shiftRanges, breakRanges, dur, breakMin, plan};
}

function computeMeta24FromShifts(){ 
  const meta24=new Array(24).fill(0);
  for(const sh of ensureArray(shiftsState)){
    const meta = Number(sh.meta_pcs ?? 0);
    if(!Number.isFinite(meta) || meta<=0) continue;
    const r=shiftsToRanges(sh);
    if(r.plan<=0) continue;

    // planned minutes per hour
    const perHour=new Array(24).fill(0);
    for(let h=0; h<24; h++){
      const h0=h*60, h1=(h+1)*60;
      perHour[h]=intervalPlannedMinutesInHour(h0,h1,r.shiftRanges,r.breakRanges);
    }
    const total=perHour.reduce((a,b)=>a+b,0);
    if(total<=0) continue;

    let acc=0;
    let assigned=0;
    for(let h=0; h<24; h++){
      if(perHour[h]<=0) continue;
      const raw = meta * (perHour[h]/total);
      const v = Math.floor(raw);
      meta24[h] += v;
      assigned += v;
    }
    // distribute remainder
    const rem = Math.max(0, Math.floor(meta) - assigned);
    if(rem>0){
      // sort hours by planned minutes desc
      const idxs=[...Array(24).keys()].filter(h=>perHour[h]>0).sort((a,b)=>perHour[b]-perHour[a]);
      for(let i=0; i<rem; i++){ meta24[idxs[i % idxs.length]] += 1; }
    }
  }
  return meta24;
}

function isHourInAnyShift(h){ 
  const h0=h*60, h1=(h+1)*60;
  for(const sh of ensureArray(shiftsState)){
    const r=shiftsToRanges(sh);
    for(const sr of r.shiftRanges){ if(overlap(h0,h1,sr[0],sr[1])) return true; }
  }
  return false;
}
function isHourInAnyBreak(h){ 
  const h0=h*60, h1=(h+1)*60;
  for(const sh of ensureArray(shiftsState)){
    const r=shiftsToRanges(sh);
    for(const br of r.breakRanges){ if(overlap(h0,h1,br[0],br[1])) return true; }
  }
  return false;
}

function renderSummary(){
  const wrap=document.getElementById("shifts-summary-wrap");
  const body=document.getElementById("shifts-summary-body");
  if(!wrap||!body) return;

  const shifts=ensureArray(shiftsState).filter(s=>s && s.start && s.end);
  if(shifts.length===0){ wrap.style.display="none"; return; }

  body.innerHTML="";
  let sumDur=0, sumBreak=0, sumPlan=0, sumMeta=0;

  shifts.forEach((s)=>{
    const r=shiftsToRanges(s);
    const meta=Number(s.meta_pcs ?? 0);
    const planH = r.plan/60;
    const metaH = (Number.isFinite(meta) && meta>0 && planH>0) ? (meta/planH) : 0;

    sumDur += r.dur;
    sumBreak += r.breakMin;
    sumPlan += r.plan;
    if(Number.isFinite(meta) && meta>0) sumMeta += Math.floor(meta);

    const tr=document.createElement("tr");
    const tds=[
      String(s.name||"-"),
      `${Math.round(r.dur)} min`,
      `${Math.round(r.breakMin)} min`,
      `${Math.round(r.plan)} min`,
      Number.isFinite(meta)?String(Math.floor(meta)):"0",
      metaH ? String(Math.round(metaH)) : "0"
    ];
    tds.forEach(v=>{ const td=document.createElement("td"); td.textContent=v; tr.appendChild(td); });
    body.appendChild(tr);
  });

  wrap.style.display="block";
  document.getElementById("sum-dur").textContent = `${Math.round(sumDur)} min`;
  document.getElementById("sum-break").textContent = `${Math.round(sumBreak)} min`;
  document.getElementById("sum-plan").textContent = `${Math.round(sumPlan)} min`;
  document.getElementById("sum-meta").textContent = String(Math.floor(sumMeta));
  const sumPlanH=sumPlan/60;
  const sumMetaH = (sumMeta>0 && sumPlanH>0) ? (sumMeta/sumPlanH) : 0;
  document.getElementById("sum-metah").textContent = sumMetaH ? String(Math.round(sumMetaH)) : "0";
}

// OP UI (mantido)
let opAtiva=null;
let opModalMode="new";
function _setOpModalMode(mode){ opModalMode=(mode==="edit")?"edit":"new";
  const t=document.getElementById("opModalTitle"); const b=document.getElementById("btnStartOp");
  if(t) t.textContent = (opModalMode==="edit") ? "Editar Ordem de Producao (OP)" : "Nova Ordem de Producao (OP)";
  if(b) b.textContent = (opModalMode==="edit") ? "Salvar Alteracoes" : "Iniciar OP";
}
function _createBobinaRow(value){
  const row=document.createElement("div"); row.style.display="flex"; row.style.gap="10px"; row.style.alignItems="center";
  const inp=document.createElement("input"); inp.type="number"; inp.min="0"; inp.step="1"; inp.className="input"; inp.placeholder="Metros"; inp.value=String(value||""); inp.style.flex="1";
  inp.setAttribute("aria-label","Bobina (metros)");
  const btn=document.createElement("button"); btn.type="button"; btn.className="btn btn-secondary"; btn.textContent="Remover";
  btn.addEventListener("click",()=>{ row.remove(); _syncHiddenBobinaFirst(); });
  row.appendChild(inp); row.appendChild(btn); return row;
}
function _getBobinasFromUI(){ const list=document.getElementById("op_bobinas_list"); if(!list) return []; const out=[];
  const rows=list.querySelectorAll("div"); rows.forEach((r)=>{ const inp=r.querySelector("input"); const v=String((inp&&inp.value)?inp.value:"").trim(); if(v) out.push(v); });
  return out;
}
function _setBobinasToUI(arr){ const list=document.getElementById("op_bobinas_list"); if(!list) return; list.innerHTML="";
  const a=Array.isArray(arr)?arr:[]; if(a.length===0){ list.appendChild(_createBobinaRow("")); return; }
  a.forEach(v=>{ list.appendChild(_createBobinaRow(v)); });
}
function _syncHiddenBobinaFirst(){ const h=document.getElementById("op_bobina"); if(!h) return; const b=_getBobinasFromUI(); h.value=b.length?b[0]:""; }
function _fillOpFormFromData(d){ document.getElementById("op_os").value=String(d.os||"");
  document.getElementById("op_lote").value=String(d.lote||""); document.getElementById("op_operador").value=String(d.operador||"");
  document.getElementById("op_gr_fio").value=String(d.gr_fio||""); document.getElementById("op_obs").value=String(d.observacoes||"");
  const bobinas = Array.isArray(d.bobinas)?d.bobinas:(d.bobina?[String(d.bobina)]:[]);
  _setBobinasToUI(bobinas); _syncHiddenBobinaFirst();
}
function _showOp(info){ const box=document.getElementById("op-ativo-box"), i=document.getElementById("op-ativo-info"),
  bn=document.getElementById("btn-op-new"), be=document.getElementById("btn-op-end");
  if(box) box.style.display="block"; if(i) i.textContent=info||"-"; if(bn) bn.style.display="none"; if(be) be.style.display="inline-block";
}
function _showNoOp(){ const box=document.getElementById("op-ativo-box"), i=document.getElementById("op-ativo-info"),
  bn=document.getElementById("btn-op-new"), be=document.getElementById("btn-op-end");
  if(box) box.style.display="none"; if(i) i.textContent="-"; if(bn) bn.style.display="inline-block"; if(be) be.style.display="none";
}
async function _getJson(url){ try{ const r=await fetch(url); if(!r.ok) return null; return await r.json(); }catch(e){ return null; } }
function _normalizeMachineStatusPayload(payload){ if(payload && typeof payload==="object" && payload.machine_status) return {machine:payload.machine_status, op:(payload.op_status||null)}; return {machine:payload, op:null}; }
async function carregarOpUI(){ const payload=await _getJson(`/machine/status?machine_id=${encodeURIComponent(machine_id)}`);
  if(payload){ const norm=_normalizeMachineStatusPayload(payload);
    if(norm.op && norm.op.active){ opAtiva=norm.op; const info=`OS ${String(opAtiva.os||"")} | Lote ${String(opAtiva.lote||"")} | Operador ${String(opAtiva.operador||"")}`; _showOp(info); return; }
  }
  const d=await _getJson(`/producao/op/status?machine_id=${encodeURIComponent(machine_id)}`);
  if(!d){ _showNoOp(); return; }
  if(d.active){ opAtiva=d; const info=`OS ${String(d.os||"")} | Lote ${String(d.lote||"")} | Operador ${String(d.operador||"")}`; _showOp(info); } else { opAtiva=null; _showNoOp(); }
}
function openOpModal(mode){ _setOpModalMode(mode);
  if(opModalMode==="edit"){ if(!opAtiva){ alert("Nao ha OP ativa para editar."); return; } _fillOpFormFromData(opAtiva); }
  else { document.getElementById("op-form").reset(); _setBobinasToUI([]); _syncHiddenBobinaFirst(); }
  const bd=document.getElementById("opModalBackdrop"); if(bd) bd.style.display="flex";
}
function closeOpModal(){ const bd=document.getElementById("opModalBackdrop"); if(bd) bd.style.display="none"; }
async function _postJson(url,p){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});
  let j=null; try{ j=await r.json(); }catch(e){}
  if(!r.ok) throw new Error((j&&j.error)?j.error:"Falha na requisicao"); return j;
}
function initOpUI(){ const bn=document.getElementById("btn-op-new"), be=document.getElementById("btn-op-end"), box=document.getElementById("op-ativo-box");
  if(box) box.addEventListener("click",()=>openOpModal("edit"));
  if(bn) bn.addEventListener("click",()=>openOpModal("new"));
  if(be) be.addEventListener("click",async()=>{ if(!confirm("Confirmar encerramento da OP ativa?")) return;
    try{ await _postJson("/producao/op/encerrar",{machine_id:machine_id}); await carregarOpUI(); }catch(err){ alert(String(err&&err.message?err.message:err)); }
  });
  const bd=document.getElementById("opModalBackdrop"), bc=document.getElementById("btnCloseOpModal"), bx=document.getElementById("btnCancelOp");
  if(bc) bc.addEventListener("click",closeOpModal); if(bx) bx.addEventListener("click",closeOpModal);
  if(bd) bd.addEventListener("click",(e)=>{ if(e && e.target===bd) closeOpModal(); });
  const btnAdd=document.getElementById("btnAddBobina"); if(btnAdd) btnAdd.addEventListener("click",()=>{ const list=document.getElementById("op_bobinas_list"); if(!list) return;
    list.appendChild(_createBobinaRow("")); _syncHiddenBobinaFirst(); });
  const list=document.getElementById("op_bobinas_list");
  if(list){ list.addEventListener("input",()=>_syncHiddenBobinaFirst()); list.addEventListener("change",()=>_syncHiddenBobinaFirst()); }
  const f=document.getElementById("op-form");
  if(f) f.addEventListener("submit",async(e)=>{ e.preventDefault();
    const os=String(document.getElementById("op_os").value||"").trim(); const lote=String(document.getElementById("op_lote").value||"").trim();
    const oper=String(document.getElementById("op_operador").value||"").trim();
    if(!os||!lote||!oper){ alert("Preencha OS, Lote e Operador."); return; }
    const payload={machine_id:machine_id, os:os, lote:lote, operador:oper, bobina:String(document.getElementById("op_bobina").value||"").trim(),
      gr_fio:String(document.getElementById("op_gr_fio").value||"").trim(), observacoes:String(document.getElementById("op_obs").value||"").trim()};
    try{ const bobinas=_getBobinasFromUI(); payload.bobinas=bobinas; payload.bobina=bobinas.length?bobinas[0]:payload.bobina;
      if(opModalMode==="edit") await _postJson("/producao/op/editar",payload); else await _postJson("/producao/op/iniciar",payload);
      closeOpModal(); await carregarOpUI();
    }catch(err){ alert(String(err&&err.message?err.message:err)); }
  });
}
initOpUI(); carregarOpUI();

// Reset manual
document.getElementById("btn-reset").addEventListener("click",function(){
  if(!confirm("CONFIRMAR RESET DA PRODUCAO?\nEssa acao grava historico e zera os contadores.")) return;
  fetch("/admin/reset-manual",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({machine_id})})
    .then(r=>r.json()).then(()=>{ alert("Producao zerada com sucesso."); carregarTabela(); });
});

// Units: nao permitir duplicado
function garantirSemDuplicar(){ const u1=document.getElementById("unidade_1"); const u2=document.getElementById("unidade_2");
  if(u1.value && u2.value && u1.value===u2.value) u2.value=""; }
document.getElementById("unidade_1").addEventListener("change",garantirSemDuplicar);
document.getElementById("unidade_2").addEventListener("change",garantirSemDuplicar);

// Submit config v2
document.getElementById("config-form").addEventListener("submit", function(e){
  e.preventDefault();
  garantirSemDuplicar();

  const u1 = document.getElementById("unidade_1").value;
  const u2 = document.getElementById("unidade_2").value;

  // Conversao so faz sentido quando existe pcs + (m ou m2) em alguma das unidades.
  const precisaConv = (
    (u1 === "pcs" && (u2 === "m" || u2 === "m2")) ||
    (u2 === "pcs" && (u1 === "m" || u1 === "m2"))
  );

  let conv = Number(document.getElementById("conv_m_por_pcs").value);
  if(!Number.isFinite(conv) || conv <= 0){
    if(precisaConv){
      alert("Conversao invalida. Use um numero maior que zero. Ex: 0.85");
      return;
    }
    // Se nao precisa de conversao, guarda 1 para manter compatibilidade.
    conv = 1;
  }

  const stopSec=Number(document.getElementById("no_count_stop_sec").value);
  if(!Number.isFinite(stopSec)||stopSec<5){ alert("Alerta de parada por inatividade invalido. Use um valor >= 5 segundos."); return; }

  const ideal=Number(document.getElementById("ideal_sec_per_piece").value);
  if(!Number.isFinite(ideal)||ideal<=0){ alert("Tempo ideal por peca invalido. Use um valor maior que zero."); return; }

  if(!Array.isArray(shiftsState) || shiftsState.length===0){ alert("Adicione pelo menos 1 turno."); return; }
  if(shiftsState.length>3){ alert("Limite: ate 3 turnos."); return; }

  const payload = {
    machine_id: machine_id,
    version: 2,
    active_days: getActiveDays(),
    shifts: shiftsState.map(s=>({
      name: String(s.name||"").trim(),
      start: String(s.start||""),
      end: String(s.end||""),
      meta_pcs: Number.isFinite(Number(s.meta_pcs)) ? Math.floor(Number(s.meta_pcs)) : 0,
      breaks: ensureArray(s.breaks).map(b=>({
        name: String(b.name||"").trim(),
        start: String(b.start||""),
        end: String(b.end||"")
      }))
    })),
    oee: {
      ideal_sec_per_piece: ideal,
      no_count_stop_sec: Math.floor(stopSec),
      ramp_percent: Number(document.getElementById("rampa").value||0)
    },
    unidade_1: u1,
    unidade_2: u2,
    conv_m_por_pcs: conv,
    units: {
      unidade_1: u1,
      unidade_2: u2,
      conv_m_por_pcs: conv
    }
  };

  fetch("/machine/config", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then((resp)=>{
    if(resp && resp.error){ alert(resp.error); return; }
    alert("Configuracao salva com sucesso!");
    clearConfigDirty();
    carregarTabela();
  })
  .catch(()=>{ alert("Erro ao salvar configuracao."); });
});

// Refugo API
function toNonNegInt(v){ const n=Number(v); if(!Number.isFinite(n)||n<0) return 0; return Math.floor(n); }
function salvarRefugoAPI(machineId, diaRef, horaDia, refugo){
  return fetch("/machine/refugo", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({machine_id:machineId, dia_ref:diaRef, hora_dia:horaDia, refugo:refugo})
  })
  .then(async (r)=>{
    let payload=null; try{ payload=await r.json(); }catch(e){}
    if(!r.ok) throw new Error((payload && payload.error) ? payload.error : "Erro ao salvar refugo");
    return payload;
  });
}

async function fetchStatus(){
  const payload=await _getJson(`/machine/status?machine_id=${encodeURIComponent(machine_id)}`);
  const norm=_normalizeMachineStatusPayload(payload||{});
  return norm.machine || {};
}

function applyConfigFromStatus(data){
  // units
  document.getElementById("unidade_1").value = data.unidade_1 ?? data.units?.unidade_1 ?? "";
  document.getElementById("unidade_2").value = data.unidade_2 ?? data.units?.unidade_2 ?? "";
  garantirSemDuplicar();
  document.getElementById("conv_m_por_pcs").value = data.conv_m_por_pcs ?? data.units?.conv_m_por_pcs ?? 1;

  // oee/ramp/stop
  const stopSec = Number(data.no_count_stop_sec ?? data.no_count_stop_threshold_sec ?? data.no_count_stop ?? data.oee?.no_count_stop_sec ?? 60);
  document.getElementById("no_count_stop_sec").value = (Number.isFinite(stopSec)&&stopSec>=5) ? Math.floor(stopSec) : 60;
  const ramp = Number(data.rampa_percentual ?? data.oee?.ramp_percent ?? 0);
  document.getElementById("rampa").value = Number.isFinite(ramp) ? Math.floor(ramp) : 0;
  const ideal = Number(data.ideal_sec_per_piece ?? data.oee?.ideal_sec_per_piece ?? 3);
  document.getElementById("ideal_sec_per_piece").value = (Number.isFinite(ideal)&&ideal>0) ? ideal : 3;

  // days
  const ad = ensureArray(data.active_days ?? data.config?.active_days ?? data.config_v2?.active_days);
  const set = new Set(ad.length ? ad.map(Number) : [0,1,2,3,4,5,6]);
  renderDays(set);

  // shifts v2
  const sh = ensureArray(data.shifts ?? data.config?.shifts ?? data.config_v2?.shifts);
  if(sh.length){
    shiftsState = sh.map((s,i)=>({
      name: String(s.name||shiftDefaultName(i)),
      start: String(s.start||"06:00"),
      end: String(s.end||"14:00"),
      meta_pcs: Number.isFinite(Number(s.meta_pcs)) ? Math.floor(Number(s.meta_pcs)) : 0,
      breaks: ensureArray(s.breaks).map(b=>({name:String(b.name||"Almoco"), start:String(b.start||""), end:String(b.end||"")}))
    }));
  } else {
    // legacy: build 1 shift from turno_inicio/turno_fim + meta_turno
    const start = String(data.turno_inicio || "06:00");
    const end = String(data.turno_fim || "14:00");
    const meta = Number(data.meta_turno ?? 0);
    shiftsState = [{name:"A", start:start, end:end, meta_pcs:(Number.isFinite(meta)&&meta>0)?Math.floor(meta):0, breaks:[]}];
  }
  if(shiftsState.length===0) shiftsState=[newShiftSkeleton(0)];
  renderShifts();
  renderSummary();
}

function buildMeta24(data){
  if(configDirty){
    return computeMeta24FromShifts();
  }
  if(Array.isArray(data.meta_por_hora_24) && data.meta_por_hora_24.length===24) return data.meta_por_hora_24.map(x=>toNonNegInt(x));
  return computeMeta24FromShifts();
}


function atualizarTabelaLocal(){
  if(!lastStatusCache){
    carregarTabela();
    return;
  }
  const data = lastStatusCache;

  const meta24 = computeMeta24FromShifts();
  const exibicao24 = (Array.isArray(data.producao_exibicao_24) && data.producao_exibicao_24.length===24) ? data.producao_exibicao_24 : null;
  const np24 = Array.isArray(data.np_por_hora_24) ? data.np_por_hora_24 : new Array(24).fill(0);
  const horaDiaAtual = new Date().getHours();
  const diaRef = data.ultimo_dia ?? data.dia_ref ?? "sem_dia";
  if(!Array.isArray(data.refugo_por_hora)) data.refugo_por_hora = new Array(24).fill(0);
  const refugo24 = data.refugo_por_hora;

  const tbody = document.querySelector("#tabela-horas tbody");
  tbody.innerHTML = "";

  for(let i=0; i<24; i++){
    const tr = document.createElement("tr");
    const inShift = isHourInAnyShift(i);
    const inBreak = isHourInAnyBreak(i);
    if(inBreak) tr.classList.add("pausa-planejada");
    else if(inShift) tr.classList.add("turno-ativo");

    const tdHora=document.createElement("td"); tdHora.textContent = HORAS_FIXAS_24[i];
    const tdMeta=document.createElement("td"); tdMeta.textContent = meta24[i] ?? 0;

    let baseVal=0;
    if(i > horaDiaAtual) baseVal = null;
    else {
      const fonte = exibicao24 ? exibicao24 : np24;
      const v = Number(fonte[i] ?? 0);
      baseVal = (Number.isFinite(v) && v>=0) ? v : 0;
    }

    const ref = toNonNegInt(refugo24[i] ?? 0);
    const tdProd=document.createElement("td");
    if(baseVal===null) tdProd.textContent="-";
    else tdProd.textContent = Math.max(0, Math.floor(baseVal) - ref);

    const tdRef=document.createElement("td");
    const input=document.createElement("input");
    input.type="number"; input.min="0"; input.step="1"; input.className="refugo-input"; input.value = ref;
    input.setAttribute("aria-label", `Refugo da hora ${i}`);
    const podeEditar = (i < horaDiaAtual);
    input.disabled = !podeEditar;

    input.addEventListener("blur", async()=>{
      if(!podeEditar){ input.value = toNonNegInt(refugo24[i] ?? 0); return; }
      const anterior = toNonNegInt(refugo24[i] ?? 0);
      const novo = toNonNegInt(input.value);
      if(novo === anterior){ input.value = novo; return; }
      try{
        await salvarRefugoAPI(machine_id, diaRef, i, novo);
        refugo24[i] = novo;
        if(baseVal===null) tdProd.textContent="-";
        else tdProd.textContent = Math.max(0, Math.floor(baseVal) - novo);
        input.value = novo;
      }catch(err){
        alert(String(err && err.message ? err.message : err));
        input.value = anterior;
        if(baseVal===null) tdProd.textContent="-";
        else tdProd.textContent = Math.max(0, Math.floor(baseVal) - anterior);
      }
    });

    tdRef.appendChild(input);
    tr.appendChild(tdHora); tr.appendChild(tdMeta); tr.appendChild(tdProd); tr.appendChild(tdRef);
    tbody.appendChild(tr);
  }
}

// Table
async function carregarTabela(){
  const data = await fetchStatus();
  lastStatusCache = data;

  if(!configDirty){
    applyConfigFromStatus(data);
  }

  const meta24 = buildMeta24(data);
  const exibicao24 = (Array.isArray(data.producao_exibicao_24) && data.producao_exibicao_24.length===24) ? data.producao_exibicao_24 : null;
  const np24 = Array.isArray(data.np_por_hora_24) ? data.np_por_hora_24 : new Array(24).fill(0);
  const horaDiaAtual = new Date().getHours();
  const diaRef = data.ultimo_dia ?? data.dia_ref ?? "sem_dia";
  const refugo24 = Array.isArray(data.refugo_por_hora) ? data.refugo_por_hora : (data.refugo_por_hora = new Array(24).fill(0));

  const tbody = document.querySelector("#tabela-horas tbody");
  tbody.innerHTML = "";

  for(let i=0; i<24; i++){
    const tr = document.createElement("tr");
    const inShift = isHourInAnyShift(i);
    const inBreak = isHourInAnyBreak(i);
    if(inBreak) tr.classList.add("pausa-planejada");
    else if(inShift) tr.classList.add("turno-ativo");

    const tdHora=document.createElement("td"); tdHora.textContent = HORAS_FIXAS_24[i];
    const tdMeta=document.createElement("td"); tdMeta.textContent = meta24[i] ?? 0;

    let baseVal=0;
    if(i > horaDiaAtual) baseVal = null;
    else {
      const fonte = exibicao24 ? exibicao24 : np24;
      const v = Number(fonte[i] ?? 0);
      baseVal = (Number.isFinite(v) && v>=0) ? v : 0;
    }

    const ref = toNonNegInt(refugo24[i] ?? 0);
    const tdProd=document.createElement("td");
    if(baseVal===null) tdProd.textContent="-";
    else tdProd.textContent = Math.max(0, Math.floor(baseVal) - ref);

    const tdRef=document.createElement("td");
    const input=document.createElement("input");
    input.type="number"; input.min="0"; input.step="1"; input.className="refugo-input"; input.value = ref;
    const podeEditar = (i < horaDiaAtual);
    input.disabled = !podeEditar;

    input.addEventListener("blur", async()=>{
      if(!podeEditar){ input.value = toNonNegInt(refugo24[i] ?? 0); return; }
      const anterior = toNonNegInt(refugo24[i] ?? 0);
      const novo = toNonNegInt(input.value);
      if(novo === anterior){ input.value = novo; return; }
      try{
        await salvarRefugoAPI(machine_id, diaRef, i, novo);
        refugo24[i] = novo;
        if(baseVal===null) tdProd.textContent="-";
        else tdProd.textContent = Math.max(0, Math.floor(baseVal) - novo);
        input.value = novo;
      }catch(err){
        alert(String(err && err.message ? err.message : err));
        input.value = anterior;
        if(baseVal===null) tdProd.textContent="-";
        else tdProd.textContent = Math.max(0, Math.floor(baseVal) - anterior);
      }
    });

    tdRef.appendChild(input);
    tr.appendChild(tdHora); tr.appendChild(tdMeta); tr.appendChild(tdProd); tr.appendChild(tdRef);
    tbody.appendChild(tr);
  }
}

// init
renderDays(new Set([0,1,2,3,4,5,6]));
shiftsState = [newShiftSkeleton(0)];
renderShifts();
renderSummary();
document.getElementById("btnAddShift").addEventListener("click",()=>{
  if(shiftsState.length>=3){ alert("Limite: ate 3 turnos."); return; }
  shiftsState.push(newShiftSkeleton(shiftsState.length));
  renderShifts(); renderSummary(); atualizarTabelaLocal();
});
carregarTabela();
</script>
{% endblock %}
