{% extends 'base.html' %}
{% block title %}Produção - IndFlow{% endblock %}

{% block content %}

<style>
    .page {
        padding: 24px;
    }

    .machine-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        margin-top: 20px;
    }

    .machine-card-link {
        text-decoration: none;
        color: inherit;
    }

    .machine-card {
        background: #ffffff;
        width: 320px;
        border-radius: 16px;
        padding: 22px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.10);
        border: 1px solid #e5e7eb;
        transition: 0.2s;
    }

    .machine-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.18);
        cursor: pointer;
    }

    .machine-name {
        font-size: 20px;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 8px;
    }

    .machine-status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-bottom: 12px;
    }

    .status-auto {
        background: #16a34a;
    }

    .status-manual {
        background: #dc2626;
    }

    .machine-value-row {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 10px;
    }

    .machine-indicator {
        font-size: 26px;
        font-weight: 900;
    }

    .ind-good { color: #16a34a; }
    .ind-normal { color: #2563eb; }
    .ind-bad { color: #dc2626; }

    .machine-value {
        font-size: 48px;
        font-weight: 700;
        color: #0f172a;
    }

    .machine-subtext {
        font-size: 15px;
        color: #475569;
        text-align: right;
        font-weight: 500;
        margin-top: 4px;
    }
</style>

<div class="page">

    <h1 class="section-title">Produção</h1>

    <div class="machine-grid" id="machines-area"></div>

</div>

<script>
const maquinas = ["maquina01"];

function formatTempoMedio(v) {
    const n = Number(v);
    if (!Number.isFinite(n) || n <= 0) return "—";
    const fixed = n >= 10 ? n.toFixed(1) : n.toFixed(2);
    return fixed.replace(".", ",");
}

function labelUnidade(u){
    if(!u) return "";
    return u.toUpperCase();
}

/* MANTIDA – não removida */
function calcularIndicador(percentual){
    const p = Number(percentual) || 0;

    if (p >= 102) return { icon: "▲", cls: "ind-good" };
    if (p <= 98)  return { icon: "▼", cls: "ind-bad" };
    return { icon: "—", cls: "ind-normal" };
}

/* NOVA – cálculo por ritmo (sem quebrar nada) */
function calcularIndicadorPorRitmo(data){
    const meta = Number(data.meta_turno) || 0;
    const produzido = Number(data.produzido_turno) || 0;

    if (!meta || !data.turno_inicio || !data.turno_fim) {
        return { icon: "—", cls: "ind-normal" };
    }

    const agora = new Date();
    const inicio = new Date(data.turno_inicio);
    const fim = new Date(data.turno_fim);

    if (agora < inicio) {
        return { icon: "—", cls: "ind-normal" };
    }

    const totalMs = fim - inicio;
    const decorridoMs = Math.min(Math.max(agora - inicio, 0), totalMs);

    if (totalMs <= 0) {
        return { icon: "—", cls: "ind-normal" };
    }

    const esperado = meta * (decorridoMs / totalMs);
    if (esperado <= 0) {
        return { icon: "—", cls: "ind-normal" };
    }

    const percentual = (produzido / esperado) * 100;
    return calcularIndicador(percentual);
}

function carregarMaquinas() {
    let area = document.getElementById("machines-area");
    area.innerHTML = "";

    maquinas.forEach(id => {

        fetch(`/machine/status?machine_id=${id}`)
        .then(r => r.json())
        .then(data => {

            let statusClass = data.status === "AUTO"
                ? "status-auto"
                : "status-manual";

            let percent = data.percentual_turno ?? 0;
            const indicador = calcularIndicadorPorRitmo(data);
            const tempoMedioTxt = formatTempoMedio(data.tempo_medio_min_por_peca);

            const unidade1 = data.unidade_1;
            const unidade2 = data.unidade_2;

            let unidadesHtml = `
                <div class="machine-subtext">
                    Meta (${labelUnidade(unidade1)}): ${data.meta_turno ?? 0}
                </div>
                <div class="machine-subtext">
                    Produzido (${labelUnidade(unidade1)}): ${data.produzido_turno ?? 0}
                </div>
            `;

            if(unidade2){
                unidadesHtml += `
                    <div class="machine-subtext">
                        Meta (${labelUnidade(unidade2)}): ${data.meta_turno ?? 0}
                    </div>
                    <div class="machine-subtext">
                        Produzido (${labelUnidade(unidade2)}): ${data.produzido_turno ?? 0}
                    </div>
                `;
            }

            let card = `
                <a href="/producao/config/${id}" class="machine-card-link">
                    <div class="machine-card">

                        <div class="machine-name">${id.toUpperCase()}</div>

                        <div class="machine-status ${statusClass}">
                            ${data.status}
                        </div>

                        <div class="machine-value-row">
                            <div class="machine-indicator ${indicador.cls}">
                                ${indicador.icon}
                            </div>
                            <div class="machine-value">${percent}%</div>
                        </div>

                        <div class="machine-subtext">Meta do Dia</div>

                        ${unidadesHtml}

                        <div class="machine-subtext">
                            Ritmo médio: ${tempoMedioTxt} min/peça
                        </div>

                    </div>
                </a>
            `;

            area.innerHTML += card;
        });
    });
}

carregarMaquinas();
setInterval(carregarMaquinas, 2000);
</script>

{% endblock %}
