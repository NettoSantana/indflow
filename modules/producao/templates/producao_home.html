<!--
Caminho: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\templates\producao_home.html
Último recode: 2026-02-04 09:00 (America/Bahia)
Motivo: Tornar o nome da máquina clicável para abrir o histórico já com machine_id (/producao/historico?machine_id=<id>), evitando tela de histórico vazia quando acessada sem querystring.
-->

{% extends 'base.html' %}
{% block title %}Produção - IndFlow{% endblock %}

{% block content %}

<style>
  .page { padding: 24px; }

  .machine-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin-top: 20px;
  }

  .machine-card {
    background: #ffffff;
    width: 520px;
    border-radius: 16px;
    padding: 22px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.10);
    border: 1px solid #e5e7eb;
  }

  .machine-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-bottom: 6px;
  }

  .machine-name {
    font-size: 22px;
    font-weight: 800;
    color: #0f172a;
    letter-spacing: 0.2px;
  }

  .machine-name-link {
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }

  .machine-header-right {
    display:flex;
    align-items:center;
    gap:10px;
  }

  .machine-status {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 800;
    color: white;
    min-width: 108px;
    text-align:center;
  }

  .status-auto { background: #16a34a; }
  .status-stop { background: #dc2626; }

  .btn-x {
    border: 1px solid #e5e7eb;
    background: #ffffff;
    border-radius: 10px;
    width: 34px;
    height: 34px;
    font-size: 18px;
    line-height: 34px;
    text-align:center;
    cursor: pointer;
  }

  .machine-stopline {
    font-size: 13px;
    font-weight: 800;
    color: #dc2626;
    margin: 6px 0 10px 0;
  }

  .split {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border-top: 1px solid #eef2f7;
    margin-top: 10px;
    padding-top: 14px;
  }

  .col {
    padding: 0 12px;
  }

  .col + .col {
    border-left: 1px solid #eef2f7;
  }

  .percent-row {
    display:flex;
    align-items: baseline;
    justify-content: center;
    gap: 10px;
    margin-top: 6px;
  }

  .indicator {
    font-size: 24px;
    font-weight: 900;
    line-height: 1;
  }

  .ind-good { color: #16a34a; }
  .ind-bad { color: #dc2626; }
  .ind-normal { color: #2563eb; }

  .percent {
    font-size: 56px;
    font-weight: 900;
    color: #0f172a;
    line-height: 1;
  }

  .subtitle {
    font-size: 14px;
    color: #475569;
    text-align:center;
    font-weight: 600;
    margin-top: 6px;
  }

  .kv {
    display:grid;
    grid-template-columns: 1fr auto;
    gap: 8px 10px;
    margin-top: 10px;
    font-size: 14px;
    color: #0f172a;
  }

  .kv .k { color: #334155; font-weight: 600; }
  .kv .v { font-weight: 800; text-align:right; }

  .footer {
    margin-top: 14px;
    text-align:center;
    color: #334155;
    font-size: 14px;
    font-weight: 700;
  }
</style>

<div class="page">
  <h1 class="section-title">Produção</h1>
  <div class="machine-grid" id="machines-area"></div>
</div>

<script>
  // Ajuste simples: aqui você controla quais máquinas aparecem.
  // No seu caso atual, é a MAQUINA02.
  const maquinas = ["maquina02"];

  function toNum(v, def=0){
    const n = Number(v);
    return Number.isFinite(n) ? n : def;
  }

  function fmt2(v){
    const n = toNum(v, 0);
    // mantém padrão simples (igual seu painel)
    const s = (Math.round(n * 100) / 100).toString();
    return s.replace(".", ",");
  }

  function fmtInt(v){
    return String(Math.floor(toNum(v, 0)));
  }

  function calcularIndicador(percentual){
    const p = toNum(percentual, 0);
    if (p >= 102) return { icon: "▲", cls: "ind-good" };
    if (p <= 98)  return { icon: "▼", cls: "ind-bad" };
    return { icon: "—", cls: "ind-normal" };
  }

  function resolveStatusUI(data){
    const ui = (data.status_ui || "").toString().trim().toUpperCase();
    if (ui === "PRODUZINDO" || ui === "PARADA") return ui;

    const raw = (data.status || "").toString().trim().toUpperCase();
    if (raw === "AUTO") return "PRODUZINDO";
    if (raw) return "PARADA";
    return "PARADA";
  }

  function resolveParadoMin(data){
    const v = Number(data.parado_min);
    if (Number.isFinite(v) && v >= 0) return Math.floor(v);
    return null;
  }

  function carregarMaquinas() {
    const area = document.getElementById("machines-area");
    area.innerHTML = "";

    maquinas.forEach(id => {
      fetch(`/machine/status?machine_id=${id}`)
        .then(r => r.json())
        .then(data => {

          const nome = (data.nome || id || "").toString().toUpperCase();
          const statusUI = resolveStatusUI(data);
          const produzindo = (statusUI === "PRODUZINDO");
          const statusClass = produzindo ? "status-auto" : "status-stop";

          const minsParado = resolveParadoMin(data);
          const stopLineHtml = (!produzindo && minsParado !== null)
            ? `<div class="machine-stopline">${minsParado} min parados</div>`
            : ``;

          // Dia (Turno)
          const percDia = toNum(data.percentual_turno, 0);
          const indDia = calcularIndicador(percDia);

          const metaDiaM   = toNum(data.meta_turno_ml, 0);     // exemplo: 306000
          const prodDiaM   = toNum(data.producao_turno_ml, 0); // exemplo: 99283.74
          const metaDiaPCS = toNum(data.meta_turno, 0);        // exemplo: 300000
          const prodDiaPCS = toNum(data.producao_turno, 0);    // exemplo: 97337

          // Hora
          const percHora = toNum(data.percentual_hora, 0);
          const indHora = calcularIndicador(percHora);

          const metaHoraM   = toNum(data.meta_hora_ml, 0);     // exemplo: 17500.14
          const prodHoraM   = toNum(data.producao_hora_ml, 0); // exemplo: 2885.58
          const metaHoraPCS = toNum(data.meta_hora_pcs, 0);    // exemplo: 17157

          // Preferência: hora líquida (se existir), senão producao_hora
          const prodHoraPCS = (data.producao_hora_liquida !== undefined && data.producao_hora_liquida !== null)
            ? toNum(data.producao_hora_liquida, 0)
            : toNum(data.producao_hora, 0);

          const tempoMedio = toNum(data.tempo_medio_min_por_peca, 0);
          const tempoMedioTxt = tempoMedio > 0 ? String(tempoMedio).replace(".", ",") : "—";

          const historicoHref = `/producao/historico?machine_id=${encodeURIComponent(id)}`;

          const card = `
            <div class="machine-card">
              <div class="machine-header">
                <div class="machine-name">
                  <a class="machine-name-link" href="${historicoHref}" title="Abrir histórico">${nome}</a>
                </div>
                <div class="machine-header-right">
                  <div class="machine-status ${statusClass}">${statusUI}</div>
                  <button class="btn-x" title="Excluir equipamento" onclick="alert('Excluir ainda não implementado'); return false;">×</button>
                </div>
              </div>

              ${stopLineHtml}

              <div class="split">
                <div class="col">
                  <div class="percent-row">
                    <div class="indicator ${indDia.cls}">${indDia.icon}</div>
                    <div class="percent">${fmtInt(percDia)}%</div>
                  </div>
                  <div class="subtitle">Meta do Dia</div>

                  <div class="kv">
                    <div class="k">Meta (M)</div><div class="v">${fmt2(metaDiaM)}</div>
                    <div class="k">Produzido (M)</div><div class="v">${fmt2(prodDiaM)}</div>
                    <div class="k">Meta (PCS)</div><div class="v">${fmtInt(metaDiaPCS)}</div>
                    <div class="k">Produzido (PCS)</div><div class="v">${fmtInt(prodDiaPCS)}</div>
                  </div>
                </div>

                <div class="col">
                  <div class="percent-row">
                    <div class="indicator ${indHora.cls}">${indHora.icon}</div>
                    <div class="percent">${fmtInt(percHora)}%</div>
                  </div>
                  <div class="subtitle">Meta da Hora</div>

                  <div class="kv">
                    <div class="k">Meta (M)</div><div class="v">${fmt2(metaHoraM)}</div>
                    <div class="k">Produzido (M)</div><div class="v">${fmt2(prodHoraM)}</div>
                    <div class="k">Meta (PCS)</div><div class="v">${fmtInt(metaHoraPCS)}</div>
                    <div class="k">Produzido (PCS)</div><div class="v">${fmtInt(prodHoraPCS)}</div>
                  </div>
                </div>
              </div>

              <div class="footer">Ritmo médio: ${tempoMedioTxt} min/peça</div>
            </div>
          `;

          area.innerHTML += card;
        })
        .catch(() => {
          area.innerHTML += `
            <div class="machine-card">
              <div class="machine-name">${id.toUpperCase()}</div>
              <div class="machine-stopline">Falha ao carregar status</div>
            </div>
          `;
        });
    });
  }

  carregarMaquinas();
  setInterval(carregarMaquinas, 2000);
</script>

{% endblock %}
