{% extends "base.html" %}
{% block title %}Histórico — IndFlow{% endblock %}
{% block content %}

<style>
  .wrap{max-width:1200px;margin:0 auto;padding:8px 12px 24px;}
  .top{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:14px;}
  .title{margin:0;font-size:26px;font-weight:900;color:#0f172a;letter-spacing:-.02em;}
  .machine{margin-top:6px;font-size:14px;font-weight:800;color:#334155;}
  .card{background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 4px 12px rgba(0,0,0,.08);overflow:hidden;}
  .bar{display:flex;align-items:flex-end;gap:10px;padding:14px;background:linear-gradient(180deg,#fff 0%,#eff6ff 100%);border-bottom:1px solid #e5e7eb;flex-wrap:wrap;}
  .g label{display:block;font-size:12px;font-weight:900;color:#475569;text-transform:uppercase;letter-spacing:.03em;margin-bottom:6px;}
  .g input{height:40px;padding:8px 10px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px;outline:none;background:#fff;min-width:220px;}
  .g input:focus{border-color:#2563eb;box-shadow:0 0 0 2px rgba(37,99,235,.18);}
  .hint{font-size:12px;color:#64748b;margin-left:auto;padding-bottom:6px;white-space:nowrap;}
  table{width:100%;border-collapse:collapse;font-size:14px;}
  thead th{background:#f1f5f9;color:#0f172a;font-weight:900;padding:12px 14px;text-align:left;border-bottom:1px solid #e5e7eb;}
  tbody td{padding:10px 14px;border-bottom:1px solid #e5e7eb;color:#0f172a;}
  tbody tr:nth-child(odd){background:#fff;}
  tbody tr:nth-child(even){background:#f8fbff;}
  tbody tr:hover{background:#eff6ff;}
  .r{text-align:right;}
  .loading td{padding:14px;text-align:center;color:#64748b;}
</style>

<div class="wrap">
  <div class="top">
    <div>
      <h1 class="title">Histórico</h1>
      <div class="machine" id="machine-name">Máquina: —</div>
    </div>
  </div>

  <div class="card">
    <div class="bar">
      <div class="g">
        <label for="filter-date">Buscar por data</label>
        <input id="filter-date" type="date">
      </div>
      <div class="hint">Selecione uma data para filtrar (opcional)</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th class="r">Produção Total</th>
          <th class="r">Peças Boas</th>
          <th class="r">Refugo</th>
        </tr>
      </thead>
      <tbody id="historico-body">
        <tr class="loading"><td colspan="4">Carregando histórico...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  function toNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }
  function toInt(v){
    const n = toNum(v);
    return n > 0 ? Math.floor(n) : 0;
  }
  function fmt(n){
    try { return new Intl.NumberFormat("pt-BR").format(toInt(n)); }
    catch(e){ return String(toInt(n)); }
  }
  function q(name){
    return new URLSearchParams(window.location.search).get(name) || "";
  }

  // Regras:
  // - produzido = snapshot/acumulado => usar MAX por data (não somar)
  // - refugo ainda não vem => 0 (mas se vier, usa MAX também)
  function groupByDateMax(rows){
    const m = new Map();

    (Array.isArray(rows) ? rows : []).forEach(r => {
      const data = String(r?.data || "").trim();
      if(!data) return;

      const prod = toInt(r?.produzido);
      const ref =
        toInt(r?.refugo ?? r?.refugos ?? r?.refugo_total ?? 0);

      if(!m.has(data)){
        m.set(data, { data, total: prod, refugo: ref });
        return;
      }
      const it = m.get(data);
      it.total = Math.max(it.total, prod);
      it.refugo = Math.max(it.refugo, ref);
    });

    const out = Array.from(m.values());
    out.forEach(x => { x.boas = Math.max(0, x.total - x.refugo); });
    out.sort((a,b) => String(b.data).localeCompare(String(a.data)));
    return out;
  }

  function render(list, filtroData){
    const tbody = document.getElementById("historico-body");
    tbody.innerHTML = "";

    const dataFiltrada = (filtroData || "").trim();
    const view = dataFiltrada ? list.filter(x => x.data === dataFiltrada) : list;

    if(!view.length){
      tbody.innerHTML = `<tr class="loading"><td colspan="4">Nenhum registro encontrado</td></tr>`;
      return;
    }

    for(const x of view){
      tbody.innerHTML += `
        <tr>
          <td>${x.data}</td>
          <td class="r">${fmt(x.total)}</td>
          <td class="r">${fmt(x.boas)}</td>
          <td class="r">${fmt(x.refugo)}</td>
        </tr>
      `;
    }
  }

  const machineId = q("machine_id");
  document.getElementById("machine-name").textContent =
    `Máquina: ${machineId ? machineId.toUpperCase() : "—"}`;

  const url = machineId
    ? `/producao/historico?machine_id=${encodeURIComponent(machineId)}`
    : "/producao/historico";

  let cache = [];

  fetch(url)
    .then(r => r.json())
    .then(rows => {
      cache = groupByDateMax(rows);
      render(cache, "");
    })
    .catch(() => {
      cache = [];
      render(cache, "");
    });

  document.getElementById("filter-date").addEventListener("change", (e) => {
    render(cache, e?.target?.value || "");
  });
</script>

{% endblock %}
