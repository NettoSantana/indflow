<!--
Caminho: C:\Users\vlula\OneDrive\Area de Trabalho\Projetos Backup\indflow\templates\historico.html
Ultimo recode: 2026-02-05 10:15 (America/Bahia)
Motivo: Corrigir botao "Zerar producao por data": habilitar apenas com data valida, ajustar layout do filtro, e corrigir chamada para /admin/reset-date (dia_ref).
-->

<!--
Caminho: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\modules\producao\templates\historico.html
Ultimo recode: 2026-02-04 19:35 (America/Bahia)
Motivo: Adicionar botao na tela Historico para zerar producao por data (frontend).
-->
<!--
PATH: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\templates\historico.html
LAST_RECODE: 2026-02-04 19:35 America/Bahia
MOTIVO: Adicionar botao na tela Historico para zerar producao por data (frontend).
-->

{% extends "base.html" %}
{% block title %}Histórico — IndFlow{% endblock %}
{% block content %}

<style>
  /* Referência: producao_home.html */
  .page{
    padding:24px;
  }

  .header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:16px;
    flex-wrap:wrap;
    margin-bottom:16px;
  }

  .subtitle{
    margin-top:6px;
    font-size:14px;
    font-weight:700;
    color:#334155;
  }

  .card{
    background:#ffffff;
    border-radius:16px;
    padding:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.10);
    border:1px solid #e5e7eb;
  }

  .filter-bar{
    display:flex;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }
  .filter-row{
    display:flex;
    align-items:flex-end;
    gap:14px;
    flex-wrap:wrap;
  }


  .filter-group label{
    display:block;
    font-size:12px;
    font-weight:800;
    color:#475569;
    text-transform:uppercase;
    letter-spacing:0.03em;
    margin-bottom:6px;
  }

  .filter-group input{
    height:40px;
    padding:8px 10px;
    border:1px solid #cbd5e1;
    border-radius:10px;
    font-size:14px;
    outline:none;
    background:#fff;
    min-width:220px;
  }

  .filter-group input:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 2px rgba(37,99,235,0.18);
  }

  .hint{
    font-size:12px;
    color:#64748b;
    
    padding-bottom:6px;
    white-space:nowrap;
  }

  /* Tabela */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th{
    background:#f1f5f9;
    color:#0f172a;
    font-weight:800;
    padding:12px 14px;
    text-align:left;
    border-bottom:1px solid #e5e7eb;
  }

  tbody td{
    padding:10px 14px;
    border-bottom:1px solid #e5e7eb;
    color:#0f172a;
  }

  tbody tr:nth-child(odd){ background:#ffffff; }
  tbody tr:nth-child(even){ background:#f8fbff; }

  tbody tr:hover{
    background:#eff6ff;
  }

  .r{ text-align:right; }

  .loading td{
    padding:14px;
    text-align:center;
    color:#64748b;
  }

  /* ===============================
     OPs no historico (adicao)
     =============================== */
  .op-row td{
    background:#f8fafc;
    color:#334155;
    font-size:13px;
    font-weight:700;
    border-bottom:1px solid #e5e7eb;
  }

  .op-pill{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    margin-right:8px;
    vertical-align:middle;
  }

  .op-pill-ativa{
    background:#dcfce7;
    color:#166534;
    border:1px solid #bbf7d0;
  }

  .op-pill-encerrada{
    background:#e5e7eb;
    color:#374151;
    border:1px solid #d1d5db;
  }

  .op-pill-unk{
    background:#f1f5f9;
    color:#334155;
    border:1px solid #e2e8f0;
  }
    .actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn-danger {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-danger:hover {
      filter: brightness(0.95);
    }
    .btn-danger:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
</style>

<div class="page">

  <div class="header-row">
    <div>
      <h1 class="section-title">Histórico</h1>
      <div class="subtitle" id="machine-name">Máquina: —</div>
    </div>
  </div>

  <div class="card">

    <!-- EM CIMA: BUSCA POR DATA -->
    <div class="filter-bar">
      <div class="filter-group">
        <label for="filter-date">Buscar por data</label>
        <input id="filter-date" type="date">
      </div>

      <div class="hint">Selecione uma data para filtrar (opcional)</div>
      <div class="actions">
        <button id="btn-reset-date" type="button" class="btn-danger">Zerar producao por data</button>
      </div>
    </div>

    <!-- EMBAIXO: TABELA POR DIA -->
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th class="r">Produção Total</th>
          <th class="r">Peças Boas</th>
          <th class="r">Refugo</th>
        </tr>
      </thead>

      <tbody id="historico-body">
        <tr class="loading"><td colspan="4">Carregando histórico...</td></tr>
      </tbody>
    </table>

  </div>

</div>

<script>
  function fmtInt(n){
    try { return new Intl.NumberFormat("pt-BR").format(Math.floor(Number(n) || 0)); }
    catch(e){ return String(Math.floor(Number(n) || 0)); }
  }

  function q(name){
    return new URLSearchParams(window.location.search).get(name) || "";
  }

  // ===============================
  // OPs helpers (adicao)
  // ===============================
  function safeStr(v){
    return String(v === undefined || v === null ? "" : v);
  }

  function fmtOpTime(s){
    // esperado ISO: YYYY-MM-DDTHH:MM:SS
    const t = safeStr(s).trim();
    if(!t) return "—";
    return t.replace("T", " ");
  }

  function opPillClass(status){
    const st = safeStr(status).trim().toUpperCase();
    if(st === "ATIVA") return "op-pill op-pill-ativa";
    if(st === "ENCERRADA") return "op-pill op-pill-encerrada";
    return "op-pill op-pill-unk";
  }

  function renderRows(rows, filtroData){
    const tbody = document.getElementById("historico-body");
    tbody.innerHTML = "";

    const dataFiltrada = (filtroData || "").trim();

    const list = (Array.isArray(rows) ? rows : [])
      .filter(r => {
        const d = String(r?.data || "").trim();
        return dataFiltrada ? d === dataFiltrada : true;
      });

    if(!list.length){
      tbody.innerHTML = `<tr class="loading"><td colspan="4">Nenhum registro encontrado</td></tr>`;
      return;
    }

    // Ordena por data desc (YYYY-MM-DD)
    list.sort((a,b) => String(b.data||"").localeCompare(String(a.data||"")));

    for(const r of list){
      const data = String(r?.data || "");
      const produzido = fmtInt(r?.produzido ?? 0);
      const boas = fmtInt(r?.pecas_boas ?? 0);
      const refugo = fmtInt(r?.refugo_total ?? r?.refugo ?? 0);

      tbody.innerHTML += `
        <tr>
          <td>${data}</td>
          <td class="r">${produzido}</td>
          <td class="r">${boas}</td>
          <td class="r">${refugo}</td>
        </tr>
      `;

      // ===============================
      // OPs abaixo do dia (adicao)
      // ===============================
      const ops = Array.isArray(r?.ops) ? r.ops : [];
      for(const op of ops){
        const st = safeStr(op?.status).trim().toUpperCase();
        const pillCls = opPillClass(st);
        const os = safeStr(op?.os).trim() || "—";
        const lote = safeStr(op?.lote).trim() || "—";
        const operador = safeStr(op?.operador).trim() || "—";
        const ini = fmtOpTime(op?.started_at);
        const fimRaw = safeStr(op?.ended_at).trim();
        const fim = fimRaw ? fmtOpTime(fimRaw) : "—";

        const periodo = (st === "ATIVA")
          ? `${ini} ate agora`
          : `${ini} ate ${fim}`;

        tbody.innerHTML += `
          <tr class="op-row">
            <td colspan="4">
              <span class="${pillCls}">${st || "OP"}</span>
              OP ${os} | Lote ${lote} | Operador ${operador} | ${periodo}
            </td>
          </tr>
        `;
      }
    }
  }

  const machineId = q("machine_id");
  document.getElementById("machine-name").textContent =
    `Máquina: ${machineId ? machineId.toUpperCase() : "—"}`;

  // ✅ IMPORTANTE:
  // A tela (HTML) é /producao/historico
  // O JSON deve vir da API /api/producao/historico
  const url = machineId
    ? `/producao/api/producao/historico?machine_id=${encodeURIComponent(machineId)}`
    : "/producao/api/producao/historico";

  let cache = [];

  async function loadHistorico() {
    const url = `/producao/api/producao/historico?machine_id=${encodeURIComponent(machineId)}`;
    try {
      const resp = await fetch(url);
      const rows = await resp.json();
      cache = Array.isArray(rows) ? rows : [];
    } catch (e) {
      cache = [];
    }

    const fd = document.getElementById('filter-date');
    const selected = (fd && fd.value) ? fd.value : '';
    renderRows(cache, selected);
  }

  loadHistorico();

  document.getElementById("filter-date").addEventListener("change", (e) => {
    renderRows(cache, e?.target?.value || "");
  });

    function normalizeDateInput(value) {
      if (!value) return null;
      const v = String(value).trim();
      // Aceita YYYY-MM-DD
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      if (iso.test(v)) return v;
      // Aceita DD/MM/AAAA
      const br = /^(\d{2})\/(\d{2})\/(\d{4})$/;
      const m = v.match(br);
      if (m) {
        const dd = m[1];
        const mm = m[2];
        const yyyy = m[3];
        return `${yyyy}-${mm}-${dd}`;
      }
      return null;
    }

    async function zerarProducaoPorData() {
      const machineId = q('machine_id');
      if (!machineId) {
        alert('machine_id nao encontrado na URL.');
        return;
      }

      const filterDateEl = document.getElementById('filter-date');
      const defaultDate = (filterDateEl && filterDateEl.value) ? filterDateEl.value : '';
      const input = prompt('Informe a data para zerar (YYYY-MM-DD ou DD/MM/AAAA):', defaultDate);
      const data = normalizeDateInput(input);
      if (!data) {
        alert('Data invalida. Use YYYY-MM-DD (ex: 2026-02-04) ou DD/MM/AAAA (ex: 04/02/2026).');
        return;
      }

      const ok = confirm(`Confirma zerar a producao da maquina ${machineId} na data ${data}?`);
      if (!ok) return;

      const btn = document.getElementById('btn-reset-date');
      if (btn) btn.disabled = true;

      try {
        const resp = await fetch('/producao/admin/reset-date', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ machine_id: machineId, data: data })
        });
        const payload = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          alert(payload.error || `Falha ao zerar producao por data. HTTP ${resp.status}`);
          return;
        }

        alert(payload.note || 'Reset por data executado.');
        // Atualiza tabela
        await loadHistorico();
      } catch (err) {
        alert('Erro ao chamar o endpoint de reset por data.');
      } finally {
        if (<div class="filter-bar">
    <div class="filter-row">
      <div class="filter-group">
        <label for="filter-date">Selecione uma data para filtrar (opcional)</label>
        <input type="date" id="filter-date" class="input" />
      </div>

      <div class="actions">
        <button id="btn-reset-date" type="button" class="btn btn-danger" disabled>
          Zerar producao por data
        </button>
      </div>
    </div>

    <div class="hint">
      Para zerar, selecione uma data. Esta acao apaga os dados de producao do dia selecionado para esta maquina.
    </div>
  </div>
</div> = false;
      }
    }

    const btnResetDate = document.getElementById('btn-reset-date');
    if (btnResetDate) {
      btnResetDate.addEventListener('click', zerarProducaoPorData);
    }
</script>

{% endblock %}