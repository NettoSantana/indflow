{% extends "base.html" %}
{% block title %}Histórico — IndFlow{% endblock %}
{% block content %}

<style>
  /* Referência: producao_home.html */
  .page{
    padding:24px;
  }

  .header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:16px;
    flex-wrap:wrap;
    margin-bottom:16px;
  }

  .subtitle{
    margin-top:6px;
    font-size:14px;
    font-weight:700;
    color:#334155;
  }

  .card{
    background:#ffffff;
    border-radius:16px;
    padding:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.10);
    border:1px solid #e5e7eb;
  }

  .filter-bar{
    display:flex;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }

  .filter-group label{
    display:block;
    font-size:12px;
    font-weight:800;
    color:#475569;
    text-transform:uppercase;
    letter-spacing:0.03em;
    margin-bottom:6px;
  }

  .filter-group input{
    height:40px;
    padding:8px 10px;
    border:1px solid #cbd5e1;
    border-radius:10px;
    font-size:14px;
    outline:none;
    background:#fff;
    min-width:220px;
  }

  .filter-group input:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 2px rgba(37,99,235,0.18);
  }

  .hint{
    font-size:12px;
    color:#64748b;
    margin-left:auto;
    padding-bottom:6px;
    white-space:nowrap;
  }

  /* Tabela */
  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th{
    background:#f1f5f9;
    color:#0f172a;
    font-weight:800;
    padding:12px 14px;
    text-align:left;
    border-bottom:1px solid #e5e7eb;
  }

  tbody td{
    padding:10px 14px;
    border-bottom:1px solid #e5e7eb;
    color:#0f172a;
  }

  tbody tr:nth-child(odd){ background:#ffffff; }
  tbody tr:nth-child(even){ background:#f8fbff; }

  tbody tr:hover{
    background:#eff6ff;
  }

  .r{ text-align:right; }

  .loading td{
    padding:14px;
    text-align:center;
    color:#64748b;
  }
</style>

<div class="page">

  <div class="header-row">
    <div>
      <h1 class="section-title">Histórico</h1>
      <div class="subtitle" id="machine-name">Máquina: —</div>
    </div>
  </div>

  <div class="card">

    <!-- EM CIMA: BUSCA POR DATA -->
    <div class="filter-bar">
      <div class="filter-group">
        <label for="filter-date">Buscar por data</label>
        <input id="filter-date" type="date">
      </div>

      <div class="hint">Selecione uma data para filtrar (opcional)</div>
    </div>

    <!-- EMBAIXO: TABELA POR DIA -->
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th class="r">Produção Total</th>
          <th class="r">Peças Boas</th>
          <th class="r">Refugo</th>
        </tr>
      </thead>

      <tbody id="historico-body">
        <tr class="loading"><td colspan="4">Carregando histórico...</td></tr>
      </tbody>
    </table>

  </div>

</div>

<script>
  function fmtInt(n){
    try { return new Intl.NumberFormat("pt-BR").format(Math.floor(Number(n) || 0)); }
    catch(e){ return String(Math.floor(Number(n) || 0)); }
  }

  function q(name){
    return new URLSearchParams(window.location.search).get(name) || "";
  }

  function renderRows(rows, filtroData){
    const tbody = document.getElementById("historico-body");
    tbody.innerHTML = "";

    const dataFiltrada = (filtroData || "").trim();

    const list = (Array.isArray(rows) ? rows : [])
      .filter(r => {
        const d = String(r?.data || "").trim();
        return dataFiltrada ? d === dataFiltrada : true;
      });

    if(!list.length){
      tbody.innerHTML = `<tr class="loading"><td colspan="4">Nenhum registro encontrado</td></tr>`;
      return;
    }

    // Ordena por data desc (YYYY-MM-DD)
    list.sort((a,b) => String(b.data||"").localeCompare(String(a.data||"")));

    for(const r of list){
      const data = String(r?.data || "");
      const produzido = fmtInt(r?.produzido ?? 0);
      const boas = fmtInt(r?.pecas_boas ?? 0);
      const refugo = fmtInt(r?.refugo_total ?? r?.refugo ?? 0);

      tbody.innerHTML += `
        <tr>
          <td>${data}</td>
          <td class="r">${produzido}</td>
          <td class="r">${boas}</td>
          <td class="r">${refugo}</td>
        </tr>
      `;
    }
  }

  const machineId = q("machine_id");
  document.getElementById("machine-name").textContent =
    `Máquina: ${machineId ? machineId.toUpperCase() : "—"}`;

  // ✅ IMPORTANTE:
  // A tela (HTML) é /producao/historico
  // O JSON deve vir da API /api/producao/historico
  const url = machineId
    ? `/api/producao/historico?machine_id=${encodeURIComponent(machineId)}`
    : "/api/producao/historico";

  let cache = [];

  fetch(url)
    .then(r => r.json())
    .then(rows => {
      cache = Array.isArray(rows) ? rows : [];
      renderRows(cache, "");
    })
    .catch(() => {
      cache = [];
      renderRows(cache, "");
    });

  document.getElementById("filter-date").addEventListener("change", (e) => {
    renderRows(cache, e?.target?.value || "");
  });
</script>

{% endblock %}
