<!--
PATH: C:\Users\vlula\OneDrive\Área de Trabalho\Projetos Backup\indflow\templates\historico.html
LAST_RECODE: 2026-02-01 11:25 America/Bahia
MOTIVO: Exibir Ordens de Produção (OPs) por dia no Histórico, usando campo `ops` retornado pela API.
-->

{% extends "base.html" %}
{% block title %}Histórico — IndFlow{% endblock %}
{% block content %}

<style>
  .page{ padding:24px; }

  .header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:16px;
    flex-wrap:wrap;
    margin-bottom:16px;
  }

  .subtitle{
    margin-top:6px;
    font-size:14px;
    font-weight:700;
    color:#334155;
  }

  .card{
    background:#ffffff;
    border-radius:16px;
    padding:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.10);
    border:1px solid #e5e7eb;
  }

  .filter-bar{
    display:flex;
    align-items:flex-end;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:14px;
  }

  .filter-group label{
    display:block;
    font-size:12px;
    font-weight:800;
    color:#475569;
    text-transform:uppercase;
    margin-bottom:6px;
  }

  .filter-group input{
    height:40px;
    padding:8px 10px;
    border:1px solid #cbd5e1;
    border-radius:10px;
    font-size:14px;
    min-width:220px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
  }

  thead th{
    background:#f1f5f9;
    font-weight:800;
    padding:12px 14px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }

  tbody td{
    padding:10px 14px;
    border-bottom:1px solid #e5e7eb;
  }

  .r{ text-align:right; }

  .op-row{
    background:#f8fafc;
    font-size:13px;
    color:#334155;
  }

  .op-tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:8px;
    font-weight:700;
    font-size:11px;
    margin-right:6px;
  }

  .op-ativa{ background:#dcfce7; color:#166534; }
  .op-encerrada{ background:#e5e7eb; color:#374151; }
</style>

<div class="page">

  <div class="header-row">
    <div>
      <h1 class="section-title">Histórico</h1>
      <div class="subtitle" id="machine-name">Máquina: —</div>
    </div>
  </div>

  <div class="card">

    <div class="filter-bar">
      <div class="filter-group">
        <label for="filter-date">Buscar por data</label>
        <input id="filter-date" type="date">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th class="r">Produção Total</th>
          <th class="r">Peças Boas</th>
          <th class="r">Refugo</th>
        </tr>
      </thead>

      <tbody id="historico-body">
        <tr><td colspan="4">Carregando histórico...</td></tr>
      </tbody>
    </table>

  </div>

</div>

<script>
  function q(name){ return new URLSearchParams(window.location.search).get(name) || ""; }
  function fmt(n){ return new Intl.NumberFormat("pt-BR").format(Number(n)||0); }

  function render(rows, filtro){
    const tb = document.getElementById("historico-body");
    tb.innerHTML = "";

    const list = (rows||[]).filter(r => !filtro || r.data === filtro);

    if(!list.length){
      tb.innerHTML = `<tr><td colspan="4">Nenhum registro</td></tr>`;
      return;
    }

    list.sort((a,b)=>b.data.localeCompare(a.data));

    for(const r of list){
      tb.innerHTML += `
        <tr>
          <td>${r.data}</td>
          <td class="r">${fmt(r.produzido)}</td>
          <td class="r">${fmt(r.pecas_boas)}</td>
          <td class="r">${fmt(r.refugo_total)}</td>
        </tr>
      `;

      if(Array.isArray(r.ops)){
        for(const op of r.ops){
          const statusCls = op.status === "ATIVA" ? "op-ativa" : "op-encerrada";
          tb.innerHTML += `
            <tr class="op-row">
              <td colspan="4">
                <span class="op-tag ${statusCls}">${op.status}</span>
                OP ${op.os} | Lote ${op.lote} | Operador ${op.operador}
                | ${op.started_at} ${op.ended_at ? "→ "+op.ended_at : ""}
              </td>
            </tr>
          `;
        }
      }
    }
  }

  const machineId = q("machine_id");
  document.getElementById("machine-name").textContent =
    `Máquina: ${machineId ? machineId.toUpperCase() : "—"}`;

  const url = machineId
    ? `/api/producao/historico?machine_id=${encodeURIComponent(machineId)}`
    : `/api/producao/historico`;

  let cache = [];

  fetch(url).then(r=>r.json()).then(d=>{
    cache = d||[];
    render(cache,"");
  });

  document.getElementById("filter-date").addEventListener("change",e=>{
    render(cache,e.target.value);
  });
</script>

{% endblock %}
